$(function(){if(zhiyou_open){var b={"redirect_url":encodeURIComponent(window.location.href)};zhiyou_relate.popup_login_init(b);}else{login();register();}var c={resizeWindow:function(d){if(window.innerHeight){winHeight=window.innerHeight;}else{if((document.body)&&(document.body.clientHeight)){winHeight=document.body.clientHeight;}}var e=(winHeight-$(d).height())/2;$(d).css("top",e);window.onresize=function(){c.resizeWindow(d);};},alert:function(f,e,d){c.showBoxy("alert",f,e,d);},confirm:function(f,e,d){c.showBoxy("confirm",f,e,d);},tips:function(f,e,d){c.showBoxy("tips",f,e,d);},destroy:function(){},showBoxy:function(g,f,e,d){c.coverInit();switch(g){case"alert":c.getAlert(f,e,d);c.resizeWindow(".smzdm_boxy_alert");break;case"confirm":break;case"tips":c.getTips(f,e,d);c.resizeWindow(".smzdm_boxy_tips");break;default:break;}},hideBoxy:function(d){d.click(function(){$("#boxyCover").hide();$(this).parent().hide();});},getAlert:function(i,h,g,f){if(i=="destroy"){$(".smzdm_boxy_alert").remove();$("#boxyCover").remove();return false;}var d=typeof(g.title)=="undefined"?"":g.title;var e='<div class="pop pop_main_box smzdm_boxy_alert" style="margin-left: -240px; top: 30%;display:none;">'+'<i class="pop-close icon-cross-lighter"><!--[if lt IE 8]>x<![endif]--></i>'+'<div class="pop-title">'+'<div class="pop_name">'+d+"</div>"+"</div>"+"<!-- pop-content -->"+'<div class="pop-content">'+i+"</div>"+"<!-- pop-content end -->"+"</div>";$(".smzdm_boxy_alert").remove();$("body").append(e);$("#boxyCover").show();$(".smzdm_boxy_alert").css("display","block");h&&h();c.hideBoxy($(".smzdm_boxy_alert").find(".pop-close"));$("#boxyCover").click(function(){c.alert("destroy");});},getTips:function(g,f,e){if(g=="destroy"){$(".smzdm_boxy_tips").remove();$("#boxyCover").remove();return false;}var d="";if(e.type=="success"){d='<i class="icon-loginright"><!--[if lt IE 8]>√<![endif]--></i>';}else{if(e.type=="error"){d='<i class="icon-logintanhao"><!--[if lt IE 8]>404<![endif]--></i>';}}var h='<div class="pop pop_no_title  smzdm_boxy_tips" style="margin-left: -155px; top: 30%;display:none;">'+'<i class="pop-close icon-cross-lighter"><!--[if lt IE 8]>x<![endif]--></i>'+'<div class="pop-content oneLine">'+d+'<p class="pop_info">'+g+"</p>"+"</div>"+"</div>";$(".smzdm_boxy_tips").remove();$("body").append(h);$("#boxyCover").show();$(".smzdm_boxy_tips").css("display","block");f&&f();c.hideBoxy($(".smzdm_boxy_tips").find(".pop-close"));$("#boxyCover").click(function(){c.tips("destroy");});},coverInit:function(){$("body").find("#boxyCover").remove();$("body").append('<div id="boxyCover"></div>');$("#boxyCover").css({background:"#000 none repeat scroll 0 0",display:"none",height:"100%",left:0,opacity:0.5,position:"fixed",top:0,width:"100%","z-index":9999});}};var a={open:function(e,d){$.ajax({type:"post",url:smzdm_post+"/ajax_get_reward_temp",data:{article_id:$("#articleID").val()},dataType:"json",async:true,cache:false,success:function(f){e&&e(f);},error:function(){d&&d();}});}};a.open(function(h){$("#reward_temp").html(h.temp);if(!h.temp){return false;}var k=$(".reward-top");if(parseInt(h.reward_num)>0){$(".reward-top span").text(h.reward_num);$(".reward-top").show();}else{$(".reward-top").html("打赏<span>Now!</span>");$(".reward-top").show();}var f=true;var i={defaultRewardType:$("#reward_type").val(),defaultRewardValue:$("#reward_count").val(),defaultRewardTemp:{},defaultItem:""};var e={type:"",count:0,needCheckSafe:false};var d={login:function(){if(zhiyou_open){zhiyou_relate.popup_login_show();}else{requestUserInfo();}}};var j={checkLogin:function(n,m,l){$.ajax({type:"post",url:smzdm_post+"/ajax_check_login",data:n,dataType:"json",async:true,cache:false,success:function(o){m&&m(o);},error:function(){l&&l();}});},sendRequest:function(n,m,l){$.ajax({type:"post",url:smzdm_post+"/ajax_reward",data:n,dataType:"json",async:true,cache:false,success:function(o){m&&m(o);},error:function(){l&&l();}});},getRewardedList:function(n,m,l){$.ajax({type:"post",url:smzdm_post+"/ajax_rewarded_list",data:n,dataType:"json",success:function(o){m&&m(o);},error:function(){l&&l();}});},showRewardedTips:function(){$(".reward-head-portrait li").hover(function(){var l=document.createElement("div");l.className="head-name";var m=$(this).find("img").attr("name");var o=$(this).find("img").attr("time");l.innerHTML="<em></em><p>"+m+'</p><p class="time">'+o+"</p>";l.style.top=0-64+"px";$(this).append(l);var n=$(".head-name").width()/2;$(".head-name").css("left",0-n-5+"px");$(".head-name").find("em").css("left",n+10+"px");},function(){$(this).find("div.head-name").remove();});},getProcessHtml:function(){var l="";return l;},initProcessTemp:function(){var l=$("#reward-default-temp");i.defaultRewardTemp=l.clone();l.remove();},customInputError:function(l){$(".custom").addClass("input-error");l&&l();},customInputSuccess:function(l){$(".custom").removeClass("input-error");l&&l();},customInputInit:function(l){$(".custom").val(l);},errorMsg:function(l){$(".pop_msg_error").html(l);},gratuityBtnGrey:function(){$(".gratuity-btn").attr("class","a_greyBlock rFloat gratuity-btn");},gratuityBtnRed:function(){$(".gratuity-btn").attr("class","a_redBlock lFloat gratuity-btn");},btnCanReward:function(){$(".gratuity-btn").addClass("can-reward");},btnDoReward:function(){$(".gratuity-btn").addClass("do-reward");},processError:function(m,n,l){j.errorMsg(m);if(l.type=="error"){j.gratuityBtnGrey();}if(l.type=="success"){j.gratuityBtnRed();}n&&n();},procesSuccess:function(l){j.errorMsg("");j.gratuityBtnRed();l&&l();},customProcessShow:function(l,m){j.customInputError();j.processError(l,function(){},{type:"error"});m&&m();},getrewardSg:function(){return{currentSilver:$("#user-silver").html(),currentGold:$("#user-gold").html()};},backGratuity:function(l){$(".back_gratuity").unbind().click(function(){$(".gratuity-success").hide();$(".gratuity-process").show();$(".gratuity-btn").remove();$(".gratuity-success").after('<a class="a_redBlock lFloat gratuity-btn can-reward" href="javascript:void(0)">打赏</a>');j.errorMsg("");l&&l();});},securityInputChange:function(l){$(".security-input").on("input",function(){if(!$(this).val()){j.processError('请输入安全密码（<a href="http://zhiyou.smzdm.com/user/find_password" target="_blank">忘记安全密码</a>）',function(){},{type:"success"});}l&&l();});},gratuityBtnInit:function(m,n){var l=$(".gratuity-btn");l.removeClass("can-reward");l.removeClass("do-reward");l.addClass(m).html(n).show().unbind();},canRewardDestroy:function(){$(".can-reward").removeClass("can-reward").unbind();},canReward:function(l){$(".can-reward").unbind().click(function(){if(f==false){return false;}f=false;var m=0;var o="";var n=true;if(i.defaultItem=="li"){n=j.rewardChoseLiCheck(e.type,e.count);}else{if(i.defaultItem=="custom"){n=j.rewardCustomCheck(e.type,e.count);}}if(n==false){f=true;return false;}j.sendRequest({reward_type:e.type,reward_count:e.count,article_id:$("#articleID").val()},function(p){f=true;if(p.error_code==0){if(e.type=="silver"){m=parseInt(e.count,10)/10;o=e.count+"碎银子";}else{if(e.type=="gold"){m=e.count;o=e.count+"金币";}else{j.processError("很抱歉，网络出了点小差，您可以关闭从新试试<span data-type='1'></span>",function(){},{type:"error"});return false;}}if(m==0){j.processError("很抱歉，网络出了点小差，您可以关闭从新试试<span data-type='2'></span>",function(){},{type:"error"});return false;}var q="<p>"+"即将对原创作者 "+p.data.article_user_name+" 的文章《"+p.data.article_title+"》进行打赏。<br/>"+"<br/>打赏"+o+"，作者将收到 "+m+"金币。"+"</p>";if(p.data.need_check_safe==true){q+='<div><input type="password" value="" placeholder="请输入安全码" class="security-input"></div>';e.needCheckSafe=true;}$(".gratuity-process").hide();$(".gratuity-success").html(q).show();if(p.data.need_check_safe==true){j.securityInputChange();if(p.data.has_safe_pass==false){j.processError('没有设置安全密码（<a href="http://zhiyou.smzdm.com/user/safepass/" target="_blank">设置安全密码</a>）',function(){},{type:"success"});}else{j.processError('<a href="http://zhiyou.smzdm.com/user/find_password" target="_blank">忘记安全密码？</a>',function(){},{type:"success"});}}$(".can-reward").addClass("do-reward").removeClass("can-reward").html("确&nbsp;&nbsp;认");j.doReward(e.type,e.count);}else{j.processError(p.error_msg,function(){},{type:"error"});$(".gratuity-btn").removeClass("can-reward");return false;}},function(){f=true;j.processError("很抱歉，网络出了点小差，您可以再试！",function(){},{type:"error"});});});},doReward:function(m,l){j.gratuityBtnInit("do-reward","确&nbsp;&nbsp;认");$(".do-reward").click(function(){if(f==false){return false;}f=false;var o=$("#articleID").val();if(!o||o==0){j.processError("很抱歉，网络出了点小差，您可以再试！",function(){},{type:"success"});f=true;return false;}var n=$(".security-input").val();if(!n&&e.needCheckSafe==true){j.processError('请输入安全密码（<a href="http://zhiyou.smzdm.com/user/find_password" target="_blank">忘记安全密码</a>）',function(){},{type:"success"});f=true;return false;}j.sendRequest({step:1,reward_type:m,reward_count:l,article_id:o,safe_pass:n},function(q){f=true;if(q.error_code==0){c.alert("destroy");c.tips("打赏成功",function(){setTimeout(function(){c.tips("destroy");},3000);},{type:"success"});var u=[];$.each($("#reward-user-list li img"),function(){u.push($.trim($(this).attr("name")));});var v=$("#reward-list-msg").attr("data-limit");if(u.indexOf(q.data.user_name)<0){var t='<li><img time="刚刚" name="'+q.data.user_name+'" src="'+q.data.avatar+'"></li>';var p=$("#reward-user-list").html();var s=t+p;$("#reward-user-list").html(s);var r=($("#reward-user-num").length>0?$("#reward-user-num").html():0)*1;r=r+1;if($("#reward-user-list li").length>v){$("#reward-user-list li:last").hide();}$("#reward-list-msg").html((r<(v*1+1)?"":"等")+'<a id="reward-user-num">'+r+"</a>人已打赏");j.showReardUserList();j.showRewardedTips();}}else{if(q.error_code==6){j.processError(q.error_msg+'，您可以换个姿势打赏，<span class="back_gratuity"><a>返回</a></span>',function(){j.backGratuity(function(){j.canReward();});},{type:"error"});}else{j.processError(q.error_msg,function(){},{type:"success"});}}},function(){f=true;j.processError('很抱歉，网络出了点小差，您可以再试！<span class="back_gratuity"><a>返回</a></span>',function(){j.backGratuity(function(){j.canReward();});},{type:"error"});});});},rewardCustomCheck:function(p,o){if(o==""){j.customProcessShow("请输入打赏金额<span data-type='1'></span>");j.customInputError();return false;}e.type=p;e.count=o;if(o.indexOf(".")>-1){j.customProcessShow(p=="silver"?"碎银子打赏只支持10的倍数哦":"金币打赏值只支持整数哦");return false;}o=o*1;j.procesSuccess();j.btnCanReward();var m=/^[0-9]*[1-9][0-9]*$/;if(!m.test(o)){j.customProcessShow(p=="silver"?"碎银子打赏只支持10的倍数哦":"金币打赏值只支持整数哦");return false;}else{if(p=="silver"){o=parseInt(o,10);if(o%10!=0){j.customProcessShow("碎银子打赏只支持10的倍数哦");return false;}}}var l=j.getrewardSg();var n=l.currentSilver;var q=l.currentGold;q=q*1;if(p=="silver"){if(o>n){j.customProcessShow("碎银子不足，您可以换个姿势打赏");return false;}}else{if(p=="gold"){if(o>q){j.customProcessShow("余额不足，您可以换个姿势打赏");return false;}}else{j.customProcessShow("很抱歉，网络出了点小差，您可以关闭从新试试<span data-type='3'></span>");return false;}}j.customInputSuccess();return true;},rewardChoseLiCheck:function(p,o){o=o*1;j.procesSuccess();j.btnCanReward();j.customInputSuccess();if(!o){j.processError("很抱歉，网络出了点小差，您可以关闭从新试试<span data-type='7'></span>",function(){},{type:"error"});return false;}var m=/^[1-9]+[0-9]*]*$/;if(!m.test(o)){j.processError("很抱歉，网络出了点小差，您可以关闭从新试试<span data-type='4'></span>",function(){},{type:"error"});return false;}else{if(p=="silver"){o=parseInt(o,10);if(o%10!=0){j.processError("很抱歉，网络出了点小差，您可以关闭从新试试<span data-type='5'></span>",function(){},{type:"error"});return false;}}}var l=j.getrewardSg();var n=l.currentSilver;var q=l.currentGold;q=q*1;if(p=="silver"){if(o>n){j.processError("碎银子不足，您可以换个姿势打赏",function(){},{type:"error"});return false;}}else{if(p=="gold"){if(o>q){j.processError("余额不足，您可以换个姿势打赏",function(){},{type:"error"});return false;}}else{j.processError("很抱歉，网络出了点小差，您可以关闭从新试试<span data-type='6'></span>",function(){},{type:"error"});return false;}}return true;},initRewardTemp:function(p,l){var q=i.defaultRewardType;var m=i.defaultRewardValue;if(p==0&&l>0){q="gold";m=1;}e.count=m;e.type=q;$(".gratuity-option-box").hide();var n=$(".chose-"+q).attr("data-items");$(".chose-"+q).prop("checked",true);$("."+n).find("li[value='"+m+"']").addClass("hover");$("."+n).show();i.defaultItem="li";var o=j.rewardChoseLiCheck(e.type,e.count);if(o){j.canReward();}$("input[name='report']").unbind().click(function(){$(".gratuity-option-box").hide();var r=$(this);var t=r.attr("data-items");var s=$("."+t);var v=s.find("li:first");s.find("li").removeClass("hover");v.addClass("hover");s.find(".custom").val("");j.procesSuccess();j.btnCanReward();s.show();e.type=$('input:radio[name="report"]:checked').val();e.count=v.attr("value");i.defaultItem="li";var u=j.rewardChoseLiCheck(e.type,e.count);if(u){j.canReward();}});$(".gratuity-option-box ul li").click(function(){i.defaultItem="li";$(this).parent().find("li").removeClass("hover");$(this).addClass("hover");j.customInputSuccess(function(){j.customInputInit("");});e.count=$(this).attr("value");e.type=$('input:radio[name="report"]:checked').val();var r=j.rewardChoseLiCheck(e.type,e.count);if(r){j.canReward();}});$(".custom").on("focus",function(){$(this).parent().find("li").removeClass("hover");e.count=0;i.defaultItem="custom";j.canReward();}).on("input",function(s){i.defaultItem="custom";e.count=$(this).val();e.type=$(this).attr("data-custom");var r=j.rewardCustomCheck(e.type,e.count);if(r){j.canReward();}});},pageChange:function(l){$(".pagination li a").click(function(n){n.preventDefault();var m=$.trim($(this).attr("href"));j.getRewardedList({article_id:l,page:m},function(o){if(o.error_code==0){if(o.data.total>0){$("#page-list-content").html(j.createPageContent(o.data));j.pageChange(l);}else{c.tips("很抱歉，网络出了点小差，刷新页面之后再试一下<span data-type='1'></span>",function(){},{type:"error"});}}else{c.tips("很抱歉，网络出了点小差，刷新页面之后再试一下<span data-type='2'></span>",function(){},{type:"error"});}},function(o){c.tips("很抱歉，网络出了点小差，刷新页面之后再试一下<span data-type='3'></span>",function(){},{type:"error"});});});},createPageContent:function(n){var q="",o="",m="",p="";var l="原创_详情页_弹窗用户";if(n.top.length>0){$.each(n.top,function(r,s){q+="<li>"+'<span class="sort_value">'+(r+1)+"</span>"+"<a onclick=\"dataLayer.push({'event':'"+l+'\'})" target="_blank" href="'+s.user_smzdm_url+'"><img src="'+s.avatar+'"></a>'+"<a onclick=\"dataLayer.push({'event':'"+l+'\'})" target="_blank" href="'+s.user_smzdm_url+'">'+'<span class="sort_txt">'+s.user_name+"</span>"+"</a>"+'<span class="gratuity_txt">打赏：'+(s.total_silver>0?"<span>"+s.total_silver+"</span>碎银子":"")+(s.total_gold>0?(s.total_silver>0?"、":"")+"<span>"+s.total_gold+"</span>金币</span>":"")+"</li>";});o='<div class="gratuity_list_new">TOP 打赏</div>'+'<ul class="gratuity_list_top">'+q+"</ul>";}if(n.page_data.length>0){$.each(n.page_data,function(r,s){m+="<li>"+"<a onclick=\"dataLayer.push({'event':'"+l+'\'})" target="_blank" href="'+s.user_smzdm_url+'"><img src="'+s.avatar+'"></a>'+"<p><a onclick=\"dataLayer.push({'event':'"+l+'\'})" target="_blank" href="'+s.user_smzdm_url+'">'+s.user_name+"</a></p>"+"<span>"+s.mod_date+"</span>"+"</li>";});p='<div class="gratuity_list_new">最新打赏</div><ul class="gratuity_list">'+m+"</ul>";}return o+p+n.pagination;},showReardUserList:function(){$("#reward-user-num").click(function(){var l=$("#articleID").val();var m=1;j.getRewardedList({article_id:l,page:m},function(n){if(n.error_code==0){if(n.data.total>0){var o='<div class="pop-interval-30" id="page-list-content">'+j.createPageContent(n.data)+"</div>";c.alert(o,function(){j.pageChange(l);},{title:n.data.total+"人已对本文进行打赏"});}}else{c.tips("很抱歉，网络出了点小差，刷新页面之后再试一下<span data-type='4'></span>",function(){},{type:"error"});}},function(n){c.tips("很抱歉，网络出了点小差，刷新页面之后再试一下<span data-type='5'></span>",function(){},{type:"error"});});});}};c.coverInit();var g=true;$("#reward").click(function(){e.needCheckSafe=false;f=true;if(g==false){return false;}var l=$("#articleID").val();if(!l){c.tips("很抱歉，网络出了点小差，刷新页面之后再试一下<span data-type='6'></span>",function(){},{type:"error"});return false;}j.checkLogin({article_id:l},function(o){if(o.error_code==0){g=true;var n=i.defaultRewardTemp;n.find(".pop-slogan-img").attr("src",o.data.avatar).parent().attr("href",o.data.smzdm_url);n.find("#user-silver").html(o.data.silver);n.find("#user-gold").html(o.data.gold);var m='<div class="pop-interval-30">'+n.html()+"</div>";n.remove();c.alert(m,function(){j.initRewardTemp(o.data.silver,o.data.gold);},{title:"打赏"});}else{if(o.error_code==5){g=true;d.login();}else{c.tips("很抱歉，网络出了点小差，刷新页面之后再试一下<span data-type='7'></span>",function(){},{type:"error"});}}},function(){c.tips("很抱歉，网络出了点小差，刷新页面之后再试一下<span data-type='8'></span>",function(){},{type:"error"});});});j.showReardUserList();j.showRewardedTips();j.initProcessTemp();},function(){c.tips("很抱歉，网络出了点小差，刷新页面之后再试一下<span data-type='8'></span>",function(){},{type:"error"});});});