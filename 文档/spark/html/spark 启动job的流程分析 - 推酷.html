<!DOCTYPE html>
<!-- saved from url=(0038)http://www.tuicool.com/articles/JBjQRr -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta content="authenticity_token" name="csrf-param">
<meta content="/HicVlUBvs3c+2aLmE9EdgCsPpFPaLXlgtzFwjZ9pDI=" name="csrf-token">
    <title>
            spark 启动job的流程分析 - 推酷
   </title>
    <meta name="description" content="spark 启动job的流程分析">
  <link rel="shortcut icon" href="http://static0.tuicool.com/favicon.ico" type="image/x-icon">
  <link href="./spark 启动job的流程分析 - 推酷_files/application-e5cb75e4968d602fb35a55cc32351c7e.css" media="screen" rel="stylesheet" type="text/css">
  <link href="http://static0.tuicool.com/assets/font-awesome.min.css" rel="stylesheet">
  <script src="./spark 启动job的流程分析 - 推酷_files/ca-pub-7054762349007490.js"></script><script type="text/javascript" async="" src="./spark 启动job的流程分析 - 推酷_files/acom"></script><script src="./spark 启动job的流程分析 - 推酷_files/application-3fabafa5779c63fdb7624908b7955c28.js" type="text/javascript"></script>

  <!--[if IE 7]>
  <link rel="stylesheet" href="http://assets.tuicool.com/assets/font-awesome-ie7.min.css">
  <![endif]--> 
    <script type="text/javascript" src="./spark 启动job的流程分析 - 推酷_files/tip.js"></script>
  
  <script type="text/javascript" src="./spark 启动job的流程分析 - 推酷_files/m.js"></script>
<script src="./spark 启动job的流程分析 - 推酷_files/ds.js"></script>
<script type="text/javascript" src="./spark 启动job的流程分析 - 推酷_files/spin.min.js"></script><style type="text/css"></style>
<link rel="stylesheet" href="http://static0.tuicool.com/assets/github.css">

<script src="./spark 启动job的流程分析 - 推酷_files/share.js"></script><link rel="stylesheet" href="http://bdimg.share.baidu.com/static/api/css/share_style1_24.css"></head>
<body class=" pace-done"><div id="BAIDU_DUP_fp_wrapper" style="position: absolute; left: -1px; bottom: -1px; z-index: 0; width: 0px; height: 0px; overflow: hidden; visibility: hidden; display: none;"><iframe id="BAIDU_DUP_fp_iframe" src="./spark 启动job的流程分析 - 推酷_files/o.html" style="width: 0px; height: 0px; visibility: hidden; display: none;"></iframe></div><div class="pace  pace-inactive"><div class="pace-progress" data-progress-text="100%" data-progress="99" style="transform: translate3d(100%, 0px, 0px);">
  <div class="pace-progress-inner"></div>
</div>
<div class="pace-activity"></div></div>
  
  <div id="header" class="navbar-fixed-top">
    <div class="container">
      <div class="navbar">
        <div class="navbar-inner">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> 
            <span class="icon-bar"></span> 
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span> 
          </a>
          <a href="http://www.tuicool.com/" class="brand">推酷</a>        
        <nav class="nav-collapse collapse">
            <ul class="nav navbar primary-nav">                            
              <li class="active">
                <a href="http://www.tuicool.com/ah">
                  文章
                </a>
              </li>              
              <li class="">
                <a href="http://www.tuicool.com/sites/hot">
                  站点
                </a>
              </li>
              <li class="">
                <a href="http://www.tuicool.com/topics">
                  主题
                </a>
              </li>
              <li class="">
                <a href="http://course.tuicool.com/">
                  公开课
                </a>
              </li>
              <li class="">
                <a href="http://huodong.tuicool.com/">
                  活动
                </a>
              </li>
              <li class="">
                <a href="http://www.tuicool.com/mobile">
                  客户端
                    <sup style="font-size:0.8em;color: #16A085;">荐</sup>
                </a>
              </li>
              <li class="dropdown">
                <a href="http://www.tuicool.com/articles/JBjQRr#" class="dropdown-toggle" data-toggle="dropdown">周刊 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="http://www.tuicool.com/mags">编程狂人</a></li>
                  <li><a href="http://www.tuicool.com/mags/design">设计匠艺</a></li> 
                  <li><a href="http://www.tuicool.com/mags/startup">创业周刊</a></li> 
                  <li><a href="http://www.tuicool.com/mags/tech">科技周刊</a></li>      
                  <li><a href="http://www.tuicool.com/mags/guru">Guru Weekly</a></li> 
                  <li><a href="http://www.tuicool.com/articles/weekly">一周拾遗</a></li>                  
                </ul>
              </li>
              
              </ul>
            <form class="navbar-search pull-left" action="http://www.tuicool.com/search">
              <input type="text" class="search-query span2" name="kw" placeholder="搜索">
            </form>
            <ul class="nav pull-right">
                <li><a href="http://www.tuicool.com/login">登录</a></li>
            </ul>
          </nav>
        </div>
      </div>
  </div>   
</div>
  <div id="flash_container" class="noPrint">    
  </div>
  
  <div class="container-fluid">  
      
<div class="row-fluid article_row_fluid">
    <div class="span8 contant article_detail_bg">
        <h1>spark 启动job的流程分析</h1>
        <div class="article_meta">
            <div style="margin-bottom: 5px;">
            <span class="timestamp">时间&nbsp;2014-05-02 12:46:27
            </span>
            <span class="from">
                <i class="icon-globe"></i>
                    <a class="cut cut28 from" href="http://www.tuicool.com/sites/vQZRB3" target="_blank">CSDN博客
                    </a>
            </span>
            </div>
            <div class="source">
                <i style="float:left;">原文</i>&nbsp; 
                <a class="cut cut70" href="http://blog.csdn.net/u014393917/article/details/24872133?utm_source=tuicool&utm_medium=referral" style="display:inline-block;">http://blog.csdn.net/u014393917/article/details/24872133</a>
            </div>
            <div>
                <span>主题</span>
                <a href="http://www.tuicool.com/topics/11090132" target="_blank">
                    <span class="new-label">Spark</span>
                </a>
                <a href="http://www.tuicool.com/topics/11030091" target="_blank">
                    <span class="new-label">HDFS</span>
                </a>
            </div>
        </div>
        <div class="article_body" id="nei">
            <div>
  <h2>
    <span>从</span>
    WordCount    <span>开始分析</span>
  </h2>
  <h3>
    <span>编写一个例子程序</span>
  </h3>
  <p>
    <span>
      <span>
        <span>编写一个从</span>
      </span>
      <span>
        <span>HDFS</span>
      </span>
      <span>
        <span>中读取并计算</span>
      </span>
      <span>
        <span>wordcount</span>
      </span>
      <span>
        <span>的例子程序</span>
      </span>
      <span>
        <span>:</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>package</strong>
          </span>
          org.apache.spark.examples        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>import</strong>
        </span>
        <span>org.apache.spark.SparkContext</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>import</strong>
        </span>
        <span>org.apache.spark.SparkContext._</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>object</strong>
        </span>
        <span>
          <u>WordCount</u>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>def</strong>
        </span>
        <span>main(args : Array[String]) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>sc</span>
        <span>=</span>
        <span>
          <strong>new</strong>
        </span>
        <span>SparkContext(args(</span>
        <span>0</span>
        <span>),</span>
        <span>"wordcount by hdfs"</span>
        <span>,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>System.getenv(</span>
        <span>"SPARK_HOME"</span>
        <span>),SparkContext.jarOfClass(</span>
        <span>
          <strong>this</strong>
        </span>
        <span>.getClass()))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//</span>
      </span>
    </span>
    <span>
      <span>
        <span>从</span>
      </span>
    </span>
    <span>
      <span>
        <span>
          <u>hadoop</u>
        </span>
        <span>
          <u>hdfs</u>
        </span>
      </span>
    </span>
    <span>
      <span>
        <span>的根路径下得到一个文件</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>file</span>
        <span>=</span>
        <span>sc</span>
        <span>.textFile(</span>
        <span>"/hadoop-test.txt"</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>counts</span>
        <span>=</span>
        <span>
          <u>file</u>
        </span>
        <span>
          <u>.flatMap(line=&gt; line.split(</u>
        </span>
        <span>
          <u>" "</u>
        </span>
        <span>
          <u>))</u>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>.map(word =&gt; (word,</span>
        <span>1</span>
        <span>)).reduceByKey(_+ _)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>counts</span>
        <span>.saveAsTextFile(</span>
        <span>"/newtest.txt"</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <h3>
    <span>生成</span>
    SparkContext    <span>实例</span>
  </h3>
  <p>
    <span>
      <span>
        <span>在上面例子中，要执行</span>
      </span>
      <span>
        <span>map/reduce</span>
      </span>
      <span>
        <span>操作，首先需要一个</span>
      </span>
      <span>
        <span>SparkContext</span>
      </span>
      <span>
        <span>，因此看看</span>
      </span>
      <span>
        <span>SparkContext</span>
      </span>
      <span>
        <span>的实例生成</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>def</strong>
          </span>
          <span>
            <strong>this</strong>
          </span>
          (        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>master: String,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>appName: String,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>sparkHome: String =</span>
        <span>
          <strong>null</strong>
        </span>
        <span>,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>jars: Seq[String] = Nil,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>environment: Map[String, String]= Map(),</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>preferredNodeLocationData:Map[String, Set[SplitInfo]] = Map()) =</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>this</strong>
        </span>
        <span>(SparkContext.updatedConf(</span>
        <span>
          <strong>new</strong>
        </span>
        <span>SparkConf(), master, appName, sparkHome, jars, environment),</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>preferredNodeLocationData)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>编写</span>
      </span>
      <span>
        <span>WordCount</span>
      </span>
      <span>
        <span>例子时使用了上面列出的构造函数，后面两个</span>
      </span>
      <span>
        <span>environment</span>
      </span>
      <span>
        <span>与</span>
      </span>
      <span>
        <span>preferredNodeLocationData</span>
      </span>
      <span>
        <span>传入为默认值。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>调用</span>
      </span>
      <span>
        <span>updatedConf</span>
      </span>
      <span>
        <span>的单例函数，生成或更新当前的</span>
      </span>
      <span>
        <span>SparkConf</span>
      </span>
      <span>
        <span>实例。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>调用</span>
      </span>
      <span>
        <span>SparkContext</span>
      </span>
      <span>
        <span>的默认构造函数。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>1.</span>
      </span>
      <span>
        <span>生成并启动监控的</span>
      </span>
      <span>
        <span>Jettyui,SparkUI.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>2.</span>
      </span>
      <span>
        <span>生成</span>
      </span>
      <span>
        <span>TaskScheduler</span>
      </span>
      <span>
        <span>实例，并启动。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>此函数会根据不同的</span>
      </span>
    </span>
    <span>
      <span>
        <span>mastername</span>
      </span>
    </span>
    <span>
      <span>
        <span>生成不同的</span>
      </span>
    </span>
    <span>
      <span>
        <span>TaskScheduler</span>
      </span>
    </span>
    <span>
      <span>
        <span>实例。</span>
      </span>
    </span>
    <span>
      <span>
        <span>,yarn-cluster</span>
      </span>
    </span>
    <span>
      <span>
        <span>为</span>
      </span>
    </span>
    <span>
      <span>
        <span>YarnClusterScheduler</span>
      </span>
    </span>
    <span>
      <span>
        <span>。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>主要用来启动</span>
      </span>
      <span>
        <span>/</span>
      </span>
      <span>
        <span>停止</span>
      </span>
      <span>
        <span>task,</span>
      </span>
      <span>
        <span>监控</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>的运行状态。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>private</strong>
        </span>
        <span>[spark]</span>
        <span>
          <strong>var</strong>
        </span>
        <span>taskScheduler</span>
        <span>= SparkContext.createTaskScheduler(</span>
        <span>
          <strong>this</strong>
        </span>
        <span>,</span>
        <span>master</span>
        <span>,</span>
        <span>appName</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>taskScheduler</span>
        <span>.start()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>3.</span>
      </span>
      <span>
        <span>生成</span>
      </span>
      <span>
        <span>DAGScheduler</span>
      </span>
      <span>
        <span>实例，并启动。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>@</span>
        <span>volatile</span>
        <span>
          <strong>private</strong>
        </span>
        <span>[spark]</span>
        <span>
          <strong>var</strong>
        </span>
        <span>dagScheduler</span>
        <span>=</span>
        <span>
          <strong>new</strong>
        </span>
        <span>DAGScheduler(</span>
        <span>taskScheduler</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>dagScheduler</span>
        <span>.start()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>在</span>
      </span>
      <span>
        <span>scheduler</span>
      </span>
      <span>
        <span>进行</span>
      </span>
      <span>
        <span>start</span>
      </span>
      <span>
        <span>操作后，通过调用</span>
      </span>
      <span>
        <span>postStartHook</span>
      </span>
      <span>
        <span>来把</span>
      </span>
      <span>
        <span>SparkContext</span>
      </span>
      <span>
        <span>添加到</span>
      </span>
      <span>
        <span>appmaster</span>
      </span>
      <span>
        <span>中。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>生成</span>
      </span>
    </span>
    <span>
      <span>
        <span>WorkerRunnable</span>
      </span>
    </span>
    <span>
      <span>
        <span>线程，通过</span>
      </span>
    </span>
    <span>
      <span>
        <span>nmclient</span>
      </span>
    </span>
    <span>
      <span>
        <span>启动</span>
      </span>
    </span>
    <span>
      <span>
        <span>worker</span>
      </span>
    </span>
    <span>
      <span>
        <span>对应的</span>
      </span>
    </span>
    <span>
      <span>
        <span>container</span>
      </span>
    </span>
    <span>
      <span>
        <span>。此</span>
      </span>
    </span>
    <span>
      <span>
        <span>container</span>
      </span>
    </span>
    <span>
      <span>
        <span>线程</span>
      </span>
    </span>
    <span>
      <span>
        <span>CoarseGrainedExecutorBackend</span>
      </span>
    </span>
    <span>
      <span>
        <span>的实例</span>
      </span>
    </span>
    <span>
      <span>
        <span>,</span>
      </span>
    </span>
    <span>
      <span>
        <span>此实例通过</span>
      </span>
    </span>
    <span>
      <span>
        <span>Executor</span>
      </span>
    </span>
    <span>
      <span>
        <span>实例来加载相关的</span>
      </span>
    </span>
    <span>
      <span>
        <span>task</span>
      </span>
    </span>
    <span>
      <span>
        <span>。</span>
      </span>
    </span>
  </p>
  <h3>
    <span>
      SparkContext.textFile      <span>生成</span>
      RDD    </span>
  </h3>
  <p>
    <span>
      <span>此方法用来生成</span>
      RDD      <span>的实例，通常读取文本文件的方式通过</span>
      textFile      <span>来进行，并其调用</span>
      hadoopFile      <span>来执行。</span>
    </span>
  </p>
  <p>
    <span>
      <span>通过</span>
      hadoopFile      <span>得到一个</span>
      HadoopRDD&lt;K,V&gt;      <span>的实例后，通过</span>
      .map      <span>得到</span>
      V      <span>的值。并生成</span>
      RDD      <span>返回。</span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>def</strong>
        </span>
        <span>textFile(path: String, minSplits: Int = defaultMinSplits):RDD[String] = {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>hadoopFile(path,classOf[TextInputFormat], classOf[LongWritable], classOf[Text],</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <u>minSplits</u>
        </span>
        <span>).map(pair=&gt; pair.</span>
        <span>_2</span>
        <span>.toString)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>最终通过</span>
      </span>
      <span>
        <span>hadoopFile</span>
      </span>
      <span>
        <span>函数生成一个</span>
      </span>
      <span>
        <span>HadoopRDD</span>
      </span>
      <span>
        <span>实例。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>def</strong>
        </span>
        <span>hadoopFile[K, V](</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>path: String,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>inputFormatClass: Class[_ &lt;:InputFormat[K, V]],</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>keyClass: Class[K],</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>valueClass: Class[V],</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>minSplits: Int = defaultMinSplits</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>): RDD[(K, V)] = {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//A</span>
        <span>
          <u>Hadoop</u>
        </span>
        <span>configuration can be about 10 KB, which is pretty big, so broadcastit.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>confBroadcast</span>
        <span>= broadcast(</span>
        <span>
          <strong>new</strong>
        </span>
        <span>
          <u>SerializableWritable</u>
        </span>
        <span>(</span>
        <span>hadoopConfiguration</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>setInputPathsFunc</span>
        <span>= (jobConf: JobConf) =&gt; FileInputFormat.setInputPaths(jobConf,path)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>new</strong>
        </span>
        <span>HadoopRDD(</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>this</strong>
        </span>
        <span>,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>confBroadcast</span>
        <span>,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>Some(</span>
        <span>setInputPathsFunc</span>
        <span>),</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>inputFormatClass,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>keyClass,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>valueClass,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>minSplits)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <h3>
    <span>
      <span>
        <span>RDD</span>
      </span>
      <span>
        <span>函数的抽象执行</span>
      </span>
    </span>
  </h3>
  <p>
    <span>
      <span>
        <span>reduceByKey</span>
      </span>
      <span>
        <span>需要执行</span>
      </span>
      <span>
        <span>shuffle</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>reduce</span>
      </span>
      <span>
        <span>，也就是需要多个</span>
      </span>
      <span>
        <span>map</span>
      </span>
      <span>
        <span>中的数据集合到相同的</span>
      </span>
      <span>
        <span>reduce</span>
      </span>
      <span>
        <span>中运行，生成相关的</span>
      </span>
      <span>
        <span>DAG</span>
      </span>
      <span>
        <span>任务</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>file</span>
        <span>=</span>
        <span>sc</span>
        <span>.textFile(</span>
        <span>"/hadoop-test.txt"</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>counts</span>
        <span>=</span>
        <span>
          <u>file</u>
        </span>
        <span>
          <u>.flatMap(line=&gt; line.split(</u>
        </span>
        <span>
          <u>" "</u>
        </span>
        <span>
          <u>))</u>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>.map(word =&gt; (word,</span>
        <span>1</span>
        <span>)).reduceByKey(_+ _)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <span>counts</span>
        </span>
        <span>.saveAsTextFile(</span>
        <span>"/newtest.txt"</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <font face="DejaVu Sans">
      <span>
        <span>
          <span>在以上代码中</span>
        </span>
      </span>
    </font>
    <font>
      <span>,textFile,flatMap,map,reduceByKey</span>
      <span>
        <span>
          <span>都</span>
        </span>
      </span>
      <span>
        <span>
          <span>是</span>
        </span>
      </span>
    </font>
    <font>
      <span>
        <span>spark</span>
      </span>
      <span>
        <span>
          <span>中</span>
        </span>
      </span>
    </font>
    <font>
      <span>
        <span>RDD</span>
      </span>
      <span>
        <span>
          <span>的</span>
        </span>
      </span>
    </font>
    <span>
      <span>
        <span>transformation,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>而</span>
      </span>
      <span>
        <span>saveAsTextFile</span>
      </span>
      <span>
        <span>才是</span>
      </span>
      <span>
        <span>RDD</span>
      </span>
      <span>
        <span>中进行执行操作的</span>
      </span>
      <span>
        <span>action.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>以下引用</span>
      </span>
      <span>
        <span>http://my-oschina-net/hanzhankang/blog/200275</span>
      </span>
      <span>
        <span>的相关说明：</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>具体可参见：</span>
      </span>
      <span>
        <span>http://spark.apache.org/docs/0.9.0/scala-programming-guide.html</span>
      </span>
      <span>
        <span>。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>1</span>
      </span>
      <span>
        <span>，</span>
      </span>
      <span>
        <span>transformation</span>
      </span>
      <span>
        <span>是得到一个新的</span>
      </span>
      <span>
        <span>RDD</span>
      </span>
      <span>
        <span>，方式很多，比如从数据源生成一个新的</span>
      </span>
      <span>
        <span>RDD</span>
      </span>
      <span>
        <span>，从</span>
      </span>
      <span>
        <span>RDD</span>
      </span>
      <span>
        <span>生成一个新的</span>
      </span>
      <span>
        <span>RDD</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>2</span>
      </span>
      <span>
        <span>，</span>
      </span>
      <span>
        <span>action</span>
      </span>
      <span>
        <span>是得到一个值，或者一个结果（直接将</span>
      </span>
      <span>
        <span>RDDcache</span>
      </span>
      <span>
        <span>到内存中）</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>所有的</span>
      </span>
      <span>
        <span>transformation</span>
      </span>
      <span>
        <span>都是采用的懒策略，就是如果只是将</span>
      </span>
      <span>
        <span>transformation</span>
      </span>
      <span>
        <span>提交是不会执行计算的，计算只有在</span>
      </span>
      <span>
        <span>action</span>
      </span>
      <span>
        <span>被提交的时候才被触发。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>transformation</span>
      </span>
      <span>
        <span>操作：</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>map(func):</span>
      </span>
      <span>
        <span>对调用</span>
      </span>
      <span>
        <span>map</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>RDD</span>
      </span>
      <span>
        <span>数据集中的每个</span>
      </span>
      <span>
        <span>element</span>
      </span>
      <span>
        <span>都使用</span>
      </span>
      <span>
        <span>func</span>
      </span>
      <span>
        <span>，然后返回一个新的</span>
      </span>
      <span>
        <span>RDD,</span>
      </span>
      <span>
        <span>这个返回的数据集是分布式的数据集</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>filter(func):</span>
      </span>
      <span>
        <span>对调用</span>
      </span>
      <span>
        <span>filter</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>RDD</span>
      </span>
      <span>
        <span>数据集中的每个元素都使用</span>
      </span>
      <span>
        <span>func</span>
      </span>
      <span>
        <span>，然后返回一个包含使</span>
      </span>
      <span>
        <span>func</span>
      </span>
      <span>
        <span>为</span>
      </span>
      <span>
        <span>true</span>
      </span>
      <span>
        <span>的元素构成的</span>
      </span>
      <span>
        <span>RDD</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>flatMap(func):</span>
      </span>
      <span>
        <span>和</span>
      </span>
      <span>
        <span>map</span>
      </span>
      <span>
        <span>差不多，但是</span>
      </span>
      <span>
        <span>flatMap</span>
      </span>
      <span>
        <span>生成的是多个结果</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>mapPartitions(func):</span>
      </span>
      <span>
        <span>和</span>
      </span>
      <span>
        <span>map</span>
      </span>
      <span>
        <span>很像，但是</span>
      </span>
      <span>
        <span>map</span>
      </span>
      <span>
        <span>是每个</span>
      </span>
      <span>
        <span>element</span>
      </span>
      <span>
        <span>，而</span>
      </span>
      <span>
        <span>mapPartitions</span>
      </span>
      <span>
        <span>是每个</span>
      </span>
      <span>
        <span>partition</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>mapPartitionsWithSplit(func):</span>
      </span>
      <span>
        <span>和</span>
      </span>
      <span>
        <span>mapPartitions</span>
      </span>
      <span>
        <span>很像，但是</span>
      </span>
      <span>
        <span>func</span>
      </span>
      <span>
        <span>作用的是其中一个</span>
      </span>
      <span>
        <span>split</span>
      </span>
      <span>
        <span>上，所以</span>
      </span>
      <span>
        <span>func</span>
      </span>
      <span>
        <span>中应该有</span>
      </span>
      <span>
        <span>index</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>sample(withReplacement,faction,seed):</span>
      </span>
      <span>
        <span>抽样</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>union(otherDataset)</span>
      </span>
      <span>
        <span>：返回一个新的</span>
      </span>
      <span>
        <span>dataset</span>
      </span>
      <span>
        <span>，包含源</span>
      </span>
      <span>
        <span>dataset</span>
      </span>
      <span>
        <span>和给定</span>
      </span>
      <span>
        <span>dataset</span>
      </span>
      <span>
        <span>的元素的集合</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>distinct([numTasks]):</span>
      </span>
      <span>
        <span>返回一个新的</span>
      </span>
      <span>
        <span>dataset</span>
      </span>
      <span>
        <span>，这个</span>
      </span>
      <span>
        <span>dataset</span>
      </span>
      <span>
        <span>含有的是源</span>
      </span>
      <span>
        <span>dataset</span>
      </span>
      <span>
        <span>中的</span>
      </span>
      <span>
        <span>distinct</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>element</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>groupByKey(numTasks):</span>
      </span>
      <span>
        <span>返回</span>
      </span>
      <span>
        <span>(K,Seq[V])</span>
      </span>
      <span>
        <span>，也就是</span>
      </span>
      <span>
        <span>hadoop</span>
      </span>
      <span>
        <span>中</span>
      </span>
      <span>
        <span>reduce</span>
      </span>
      <span>
        <span>函数接受的</span>
      </span>
      <span>
        <span>key-valuelist</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>reduceByKey(func,[numTasks]):</span>
      </span>
      <span>
        <span>就是用一个给定的</span>
      </span>
      <span>
        <span>reducefunc</span>
      </span>
      <span>
        <span>再作用在</span>
      </span>
      <span>
        <span>groupByKey</span>
      </span>
      <span>
        <span>产生的</span>
      </span>
      <span>
        <span>(K,Seq[V]),</span>
      </span>
      <span>
        <span>比如求和，求平均数</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>sortByKey([ascending],[numTasks]):</span>
      </span>
      <span>
        <span>按照</span>
      </span>
      <span>
        <span>key</span>
      </span>
      <span>
        <span>来进行排序，是升序还是降序，</span>
      </span>
      <span>
        <span>ascending</span>
      </span>
      <span>
        <span>是</span>
      </span>
      <span>
        <span>boolean</span>
      </span>
      <span>
        <span>类型</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>join(otherDataset,[numTasks]):</span>
      </span>
      <span>
        <span>当有两个</span>
      </span>
      <span>
        <span>KV</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>dataset(K,V)</span>
      </span>
      <span>
        <span>和</span>
      </span>
      <span>
        <span>(K,W)</span>
      </span>
      <span>
        <span>，返回的是</span>
      </span>
      <span>
        <span>(K,(V,W))</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>dataset,numTasks</span>
      </span>
      <span>
        <span>为并发的任务数</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>cogroup(otherDataset,[numTasks]):</span>
      </span>
      <span>
        <span>当有两个</span>
      </span>
      <span>
        <span>KV</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>dataset(K,V)</span>
      </span>
      <span>
        <span>和</span>
      </span>
      <span>
        <span>(K,W)</span>
      </span>
      <span>
        <span>，返回的是</span>
      </span>
      <span>
        <span>(K,Seq[V],Seq[W])</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>dataset,numTasks</span>
      </span>
      <span>
        <span>为并发的任务数</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>cartesian(otherDataset)</span>
      </span>
      <span>
        <span>：笛卡尔积就是</span>
      </span>
      <span>
        <span>m*n</span>
      </span>
      <span>
        <span>，大家懂的</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>action</span>
      </span>
      <span>
        <span>操作：</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>reduce(func)</span>
      </span>
      <span>
        <span>：说白了就是聚集，但是传入的函数是两个参数输入返回一个值，这个函数必须是满足交换律和结合律的</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>collect()</span>
      </span>
      <span>
        <span>：一般在</span>
      </span>
      <span>
        <span>filter</span>
      </span>
      <span>
        <span>或者足够小的结果的时候，再用</span>
      </span>
      <span>
        <span>collect</span>
      </span>
      <span>
        <span>封装返回一个数组</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>count():</span>
      </span>
      <span>
        <span>返回的是</span>
      </span>
      <span>
        <span>dataset</span>
      </span>
      <span>
        <span>中的</span>
      </span>
      <span>
        <span>element</span>
      </span>
      <span>
        <span>的个数</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>first():</span>
      </span>
      <span>
        <span>返回的是</span>
      </span>
      <span>
        <span>dataset</span>
      </span>
      <span>
        <span>中的第一个元素</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>take(n):</span>
      </span>
      <span>
        <span>返回前</span>
      </span>
      <span>
        <span>n</span>
      </span>
      <span>
        <span>个</span>
      </span>
      <span>
        <span>elements</span>
      </span>
      <span>
        <span>，这个士</span>
      </span>
      <span>
        <span>driverprogram</span>
      </span>
      <span>
        <span>返回的</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>takeSample(withReplacement</span>
      </span>
      <span>
        <span>，</span>
      </span>
      <span>
        <span>num</span>
      </span>
      <span>
        <span>，</span>
      </span>
      <span>
        <span>seed)</span>
      </span>
      <span>
        <span>：抽样返回一个</span>
      </span>
      <span>
        <span>dataset</span>
      </span>
      <span>
        <span>中的</span>
      </span>
      <span>
        <span>num</span>
      </span>
      <span>
        <span>个元素，随机种子</span>
      </span>
      <span>
        <span>seed</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>saveAsTextFile</span>
      </span>
      <span>
        <span>（</span>
      </span>
      <span>
        <span>path</span>
      </span>
      <span>
        <span>）：把</span>
      </span>
      <span>
        <span>dataset</span>
      </span>
      <span>
        <span>写到一个</span>
      </span>
      <span>
        <span>textfile</span>
      </span>
      <span>
        <span>中，或者</span>
      </span>
      <span>
        <span>hdfs</span>
      </span>
      <span>
        <span>，或者</span>
      </span>
      <span>
        <span>hdfs</span>
      </span>
      <span>
        <span>支持的文件系统中，</span>
      </span>
      <span>
        <span>spark</span>
      </span>
      <span>
        <span>把每条记录都转换为一行记录，然后写到</span>
      </span>
      <span>
        <span>file</span>
      </span>
      <span>
        <span>中</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>saveAsSequenceFile(path):</span>
      </span>
      <span>
        <span>只能用在</span>
      </span>
      <span>
        <span>key-value</span>
      </span>
      <span>
        <span>对上，然后生成</span>
      </span>
      <span>
        <span>SequenceFile</span>
      </span>
      <span>
        <span>写到本地或者</span>
      </span>
      <span>
        <span>hadoop</span>
      </span>
      <span>
        <span>文件系统</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>countByKey()</span>
      </span>
      <span>
        <span>：返回的是</span>
      </span>
      <span>
        <span>key</span>
      </span>
      <span>
        <span>对应的个数的一个</span>
      </span>
      <span>
        <span>map</span>
      </span>
      <span>
        <span>，作用于一个</span>
      </span>
      <span>
        <span>RDD</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>foreach(func):</span>
      </span>
      <span>
        <span>对</span>
      </span>
      <span>
        <span>dataset</span>
      </span>
      <span>
        <span>中的每个元素都使用</span>
      </span>
      <span>
        <span>func</span>
      </span>
    </span>
  </p>
  <h3>
    <span>
      <span>
        <span>RDD</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>action</span>
      </span>
      <span>
        <span>中提交</span>
      </span>
      <span>
        <span>Job</span>
      </span>
    </span>
  </h3>
  <p>
    <span>
      <span>
        <span>在执行</span>
      </span>
      <span>
        <span>RDD</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>saveAsTextFile</span>
      </span>
      <span>
        <span>时调用</span>
      </span>
      <span>
        <span>SparkContext.runJob</span>
      </span>
      <span>
        <span>方法</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>saveAsTextFile</span>
      </span>
      <span>
        <span>
          <span>方法，</span>
        </span>
      </span>
    </font>
    <font>
      <span>
        <span>--&gt;saveAsHadoopFile,</span>
      </span>
      <span>
        <span>
          <span>最终调用</span>
        </span>
      </span>
    </font>
    <font>
      <span>
        <span>SparkContext.runJob</span>
      </span>
      <span>
        <span>
          <span>方法</span>
        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>def</strong>
        </span>
        <span>saveAsTextFile(path: String) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <u>
            <strong>this</strong>
          </u>
        </span>
        <span>
          <u>.map(x=&gt; (NullWritable.get(),</u>
        </span>
        <span>
          <u>
            <strong>new</strong>
          </u>
        </span>
        <span>
          <u>Text(x.toString)))</u>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>.saveAsHadoopFile[TextOutputFormat[NullWritable,Text]](path)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>......</span>
      </span>
      <span>
        <span>以下一行代码就是在</span>
      </span>
      <span>
        <span>saveASTextFile</span>
      </span>
      <span>
        <span>函数嵌套调用中最终调用的函数，调用</span>
      </span>
      <span>
        <span>SparkContext.runJob</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>self.context.runJob(self,writeToFile _)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>SparkContext.runJob</span>
      </span>
      <span>
        <span>的定义：</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>def</strong>
          </span>
          runJob[T, U: ClassTag](rdd: RDD[T], func: (TaskContext, Iterator[T])=&gt; U): Array[U] = {        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>runJob(rdd, func,</span>
        <span>
          <u>0</u>
        </span>
        <span>until</span>
        <span>
          <u>rdd.partitions</u>
        </span>
        <span>.size,</span>
        <span>
          <strong>false</strong>
        </span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>SparkContext</span>
      </span>
      <span>
        <span>的最终执行</span>
      </span>
      <span>
        <span>runJob</span>
      </span>
      <span>
        <span>函数定义</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>def</strong>
          </span>
          runJob[T, U: ClassTag](        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>rdd: RDD[T],//</span>
      </span>
      <span>
        <span>此处是具体的</span>
      </span>
      <span>
        <span>RDD</span>
      </span>
      <span>
        <span>实例值</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>func: (TaskContext, Iterator[T])=&gt; U,//</span>
      </span>
      <span>
        <span>具体的执行的</span>
      </span>
      <span>
        <span>action</span>
      </span>
      <span>
        <span>的逻辑</span>
      </span>
      <span>
        <span>,</span>
      </span>
      <span>
        <span>如</span>
      </span>
      <span>
        <span>reduceByKey</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>partitions:Seq[Int],//</span>
      </span>
      <span>
        <span>分区数组</span>
      </span>
      <span>
        <span>,</span>
      </span>
      <span>
        <span>一个数值从</span>
      </span>
      <span>
        <span>0</span>
      </span>
      <span>
        <span>到</span>
      </span>
      <span>
        <span>partitions.size-1</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>allowLocal: Boolean,//</span>
      </span>
      <span>
        <span>是否可以在本地执行</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//result</span>
      </span>
      <span>
        <span>的处理逻辑</span>
      </span>
      <span>
        <span>,</span>
      </span>
      <span>
        <span>每一个</span>
      </span>
      <span>
        <span>Task</span>
      </span>
      <span>
        <span>的处理</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>resultHandler: (Int, U)</span>
        <span>
          <u>=&gt;</u>
        </span>
        <span>Unit) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>callSite</span>
        <span>=getCallSite</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>cleanedFunc</span>
        <span>= clean(func)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>"Startingjob: "</span>
        <span>+</span>
        <span>callSite</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>start</span>
        <span>=System.nanoTime</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>通过</span>
      </span>
      <span>
        <span>DAGScheduler.runJob</span>
      </span>
      <span>
        <span>去执行</span>
      </span>
      <span>
        <span>job</span>
      </span>
      <span>
        <span>的运行操作，请看下面的</span>
      </span>
      <span>
        <span>DAGScheduler</span>
      </span>
      <span>
        <span>处理</span>
      </span>
      <span>
        <span>job</span>
      </span>
      <span>
        <span>提交。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>dagScheduler</span>
        <span>.runJob(rdd,</span>
        <span>cleanedFunc</span>
        <span>,partitions,</span>
        <span>callSite</span>
        <span>,allowLocal,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>resultHandler,</span>
        <span>localProperties</span>
        <span>.get)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>"Jobfinished: "</span>
        <span>+</span>
        <span>callSite</span>
        <span>+</span>
        <span>", took "</span>
        <span>+ (System.nanoTime -</span>
        <span>start</span>
        <span>)/</span>
        <span>1e9</span>
        <span>+</span>
        <span>"s"</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>rdd.doCheckpoint()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <h3>
    DAGScheduler    <span>处理</span>
    job    <span>提交</span>
  </h3>
  <p>
    <span>
      <span>
        <span>上面的函数最终通过</span>
      </span>
      <span>
        <span>DagScheduler.runJob</span>
      </span>
      <span>
        <span>进行执行。</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>def</strong>
          </span>
          runJob[T, U: ClassTag](        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>rdd: RDD[T],</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>func: (TaskContext, Iterator[T])=&gt; U,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>partitions: Seq[Int],</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>callSite: String,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>allowLocal: Boolean,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>resultHandler: (Int, U) =&gt;Unit,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>properties: Properties =</span>
        <span>
          <strong>null</strong>
        </span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>waiter</span>
        <span>=submitJob(rdd, func, partitions, callSite, allowLocal, resultHandler,properties)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>等待</span>
      </span>
      <span>
        <span>job</span>
      </span>
      <span>
        <span>运行完成。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>waiter</span>
        <span>.awaitResult()</span>
        <span>
          <strong>match</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>case</strong>
        </span>
        <span>JobSucceeded =&gt; {}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>case</strong>
        </span>
        <span>JobFailed(</span>
        <span>exception</span>
        <span>:Exception, _) =&gt;</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>"Failedto run "</span>
        <span>+ callSite)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>throw</strong>
        </span>
        <span>exception</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>调用</span>
      </span>
      <span>
        <span>DAGShceduler.submitJob</span>
      </span>
      <span>
        <span>来提交任务。</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>def</strong>
          </span>
          submitJob[T, U](        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>rdd: RDD[T],</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>func: (TaskContext, Iterator[T])=&gt; U,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>partitions: Seq[Int],</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>callSite: String,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>allowLocal: Boolean,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>resultHandler: (Int, U) =&gt;Unit,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>properties: Properties =</span>
        <span>
          <strong>null</strong>
        </span>
        <span>):JobWaiter[U] =</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//Check to make sure we are not launching a task on a partition thatdoes not exist.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>
          <u>maxPartitions</u>
        </span>
        <span>= rdd.partitions.length</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>partitions.find(p =&gt; p &gt;=</span>
        <span>maxPartitions</span>
        <span>).foreach{ p =&gt;</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>throw</strong>
        </span>
        <span>
          <strong>new</strong>
        </span>
        <span>IllegalArgumentException(</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>"Attemptingto access a non-existent partition: "</span>
        <span>+ p +</span>
        <span>". "</span>
        <span>+</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>"Totalnumber of partitions: "</span>
        <span>+</span>
        <span>maxPartitions</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>jobId</span>
        <span>=</span>
        <span>nextJobId</span>
        <span>.getAndIncrement()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(partitions.size ==</span>
        <span>0</span>
        <span>){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>return</strong>
        </span>
        <span>
          <strong>new</strong>
        </span>
        <span>JobWaiter[U](</span>
        <span>
          <strong>this</strong>
        </span>
        <span>,</span>
        <span>jobId</span>
        <span>,</span>
        <span>0</span>
        <span>,resultHandler)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>assert(partitions.size &gt;</span>
        <span>0</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>func2</span>
        <span>=func.asInstanceOf[(TaskContext, Iterator[_]) =&gt; _]</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>waiter</span>
        <span>=</span>
        <span>
          <strong>new</strong>
        </span>
        <span>JobWaiter(</span>
        <span>
          <strong>this</strong>
        </span>
        <span>,</span>
        <span>jobId</span>
        <span>,partitions.size, resultHandler)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>向</span>
      </span>
      <span>
        <span>akka</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>actor</span>
      </span>
      <span>
        <span>发送一个</span>
      </span>
      <span>
        <span>event,</span>
      </span>
      <span>
        <span>此</span>
      </span>
      <span>
        <span>event</span>
      </span>
      <span>
        <span>为</span>
      </span>
      <span>
        <span>JobSubmitted,!</span>
      </span>
      <span>
        <span>表示发送消息</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <u>eventProcessActor</u>
        </span>
        <span>! JobSubmitted(</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>jobId</span>
        <span>,rdd,</span>
        <span>func2</span>
        <span>,partitions.toArray, allowLocal, callSite,</span>
        <span>waiter</span>
        <span>,properties)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>waiter</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <font face="DejaVu Sans">
      <span>
        <span>
          <span>在</span>
        </span>
      </span>
    </font>
    <font>
      <span>
        <span>DAGShceduler</span>
      </span>
      <span>
        <span>
          <span>中的</span>
        </span>
      </span>
    </font>
    <font>
      <span>
        <span>start</span>
      </span>
      <span>
        <span>
          <span>方法时，会生成如下代码，此代码</span>
        </span>
      </span>
    </font>
    <font>
      <span>
        <span>receive</span>
      </span>
      <span>
        <span>
          <span>接收</span>
        </span>
      </span>
    </font>
    <font>
      <span>
        <span>eventProcessActor</span>
      </span>
      <span>
        <span>
          <span>发送的消息并进行处理</span>
        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>def</strong>
        </span>
        <span>start() {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>eventProcessActor</span>
        <span>= env.</span>
        <span>actorSystem</span>
        <span>.actorOf(Props(</span>
        <span>
          <strong>new</strong>
        </span>
        <span>Actor {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>/**</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>* A handle to the periodicaltask, used to cancel the task when the actor is stopped.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>*/</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>var</strong>
        </span>
        <span>resubmissionTask</span>
        <span>:Cancellable = _</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>override</strong>
        </span>
        <span>
          <strong>def</strong>
        </span>
        <span>preStart() {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>import</strong>
        </span>
        <span>context.dispatcher</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>/**</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>* A message is sent to theactor itself periodically to remind the actor to resubmit failed</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          * stages. In this way, stage          <u>resubmission</u>
          can be done within the same thread context of        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>* other event processing logicto avoid unnecessary synchronization overhead.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>*/</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>resubmissionTask</span>
        <span>=</span>
        <span>context</span>
        <span>.system.scheduler.schedule(</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>RESUBMIT_TIMEOUT</span>
        <span>,</span>
        <span>RESUBMIT_TIMEOUT</span>
        <span>,</span>
        <span>self</span>
        <span>,ResubmitFailedStages)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>/**</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>* The main event loop of the DAGscheduler.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>*/</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>接收发送的</span>
      </span>
      <span>
        <span>scheduler</span>
      </span>
      <span>
        <span>事件，并通过</span>
      </span>
      <span>
        <span>processEvent</span>
      </span>
      <span>
        <span>进行处理。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>def</strong>
        </span>
        <span>receive = {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>case</strong>
        </span>
        <span>event</span>
        <span>:DAGSchedulerEvent =&gt;</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logTrace(</span>
        <span>"Gotevent of type "</span>
        <span>+</span>
        <span>event</span>
        <span>.getClass.getName)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>/**</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>* All events are forwarded to`processEvent()`, so that the event processing logic can</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>* easily tested withoutstarting a dedicated actor. Please refer to `DAGSchedulerSuite`</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>* for details.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>*/</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(!processEvent(</span>
        <span>event</span>
        <span>)){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>submitWaitingStages()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
        <span>
          <strong>else</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>resubmissionTask</span>
        <span>.cancel()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>context</span>
        <span>.stop(</span>
        <span>self</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>processEvent</span>
      </span>
      <span>
        <span>
          <span>中处理</span>
        </span>
      </span>
    </font>
    <font>
      <span>
        <span>JobSubmitted</span>
      </span>
      <span>
        <span>
          <span>的处理流程</span>
        </span>
      </span>
    </font>
    <span>
      <span>
        <span>:</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>以下代码中生成一个</span>
      </span>
      <span>
        <span>finalStage,</span>
      </span>
      <span>
        <span>每一个</span>
      </span>
      <span>
        <span>JOB</span>
      </span>
      <span>
        <span>都有一个</span>
      </span>
      <span>
        <span>finalStage,</span>
      </span>
      <span>
        <span>根据</span>
      </span>
      <span>
        <span>job</span>
      </span>
      <span>
        <span>划分出不同的</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>，并且提交</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>：</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>private</strong>
        </span>
        <span>[scheduler]</span>
        <span>
          <strong>def</strong>
        </span>
        <span>processEvent(event: DAGSchedulerEvent): Boolean = {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>event</span>
        <span>
          <strong>match</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>case</strong>
        </span>
        <span>JobSubmitted(</span>
        <span>jobId</span>
        <span>,</span>
        <span>rdd</span>
        <span>,</span>
        <span>func</span>
        <span>,</span>
        <span>partitions</span>
        <span>,</span>
        <span>allowLocal</span>
        <span>,</span>
        <span>callSite</span>
        <span>,</span>
        <span>listener</span>
        <span>,</span>
        <span>properties</span>
        <span>)=&gt;</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>var</strong>
        </span>
        <span>finalStage</span>
        <span>:Stage =</span>
        <span>
          <strong>null</strong>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>try</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//New stage creation may throw an exception if, for example, jobs arerun on a HadoopRDD</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//whose underlying HDFS files have been deleted.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>finalStage</span>
        <span>= newStage(</span>
        <span>rdd</span>
        <span>,</span>
        <span>
          <u>partitions</u>
        </span>
        <span>.size,None,</span>
        <span>jobId</span>
        <span>,Some(</span>
        <span>callSite</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
        <span>
          <strong>catch</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>case</strong>
        </span>
        <span>e</span>
        <span>:Exception =&gt;</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logWarning(</span>
        <span>"Creatingnew stage failed due to exception - job: "</span>
        <span>+</span>
        <span>jobId</span>
        <span>,</span>
        <span>e</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>listener</span>
        <span>.jobFailed(</span>
        <span>e</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>return</strong>
        </span>
        <span>
          <strong>false</strong>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>job</span>
        <span>=</span>
        <span>
          <strong>new</strong>
        </span>
        <span>ActiveJob(</span>
        <span>jobId</span>
        <span>,</span>
        <span>finalStage</span>
        <span>,</span>
        <span>func</span>
        <span>,</span>
        <span>partitions</span>
        <span>,</span>
        <span>callSite</span>
        <span>,</span>
        <span>listener</span>
        <span>,</span>
        <span>properties</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>clearCacheLocs()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>"Gotjob "</span>
        <span>+</span>
        <span>job</span>
        <span>.</span>
        <span>jobId</span>
        <span>+</span>
        <span>" ("</span>
        <span>+</span>
        <span>callSite</span>
        <span>+</span>
        <span>") with "</span>
        <span>+</span>
        <span>partitions</span>
        <span>.length+</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>"output partitions (allowLocal="</span>
        <span>+</span>
        <span>allowLocal</span>
        <span>+</span>
        <span>")"</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>"Finalstage: "</span>
        <span>+</span>
        <span>finalStage</span>
        <span>+</span>
        <span>" ("</span>
        <span>+</span>
        <span>finalStage</span>
        <span>.</span>
        <span>name</span>
        <span>+</span>
        <span>")"</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>"Parentsof final stage: "</span>
        <span>+</span>
        <span>finalStage</span>
        <span>.</span>
        <span>parents</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>"Missingparents: "</span>
        <span>+getMissingParentStages(</span>
        <span>finalStage</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>如果可以本地运行，同时此</span>
      </span>
      <span>
        <span>finalStage</span>
      </span>
      <span>
        <span>没有</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>的依赖关系</span>
      </span>
      <span>
        <span>,</span>
      </span>
      <span>
        <span>同时</span>
      </span>
      <span>
        <span>partitions</span>
      </span>
      <span>
        <span>只有一个。也就是只有一个处理的</span>
      </span>
      <span>
        <span>split</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>那么这时直接通过</span>
      </span>
      <span>
        <span>localThread</span>
      </span>
      <span>
        <span>的方式来运行此</span>
      </span>
      <span>
        <span>job</span>
      </span>
      <span>
        <span>实例。不通过</span>
      </span>
      <span>
        <span>TaskScheduler</span>
      </span>
      <span>
        <span>进行处理。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(</span>
        <span>allowLocal</span>
        <span>&amp;&amp;</span>
        <span>finalStage</span>
        <span>.</span>
        <span>parents</span>
        <span>.size==</span>
        <span>0</span>
        <span>&amp;&amp;</span>
        <span>partitions</span>
        <span>.length==</span>
        <span>1</span>
        <span>) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//Compute very short actions like first() or take() with no parentstages locally.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>listenerBus</span>
        <span>.post(SparkListenerJobStart(</span>
        <span>job</span>
        <span>,Array(),</span>
        <span>properties</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>runLocally(</span>
        <span>job</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
        <span>
          <strong>else</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>否则表示</span>
      </span>
      <span>
        <span>partitions</span>
      </span>
      <span>
        <span>有多个，或者</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>本身的依赖关系，也就是像</span>
      </span>
      <span>
        <span>reduce</span>
      </span>
      <span>
        <span>这种场景。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>根据</span>
      </span>
      <span>
        <span>job</span>
      </span>
      <span>
        <span>对应的</span>
      </span>
      <span>
        <span>stage(finalStage),</span>
      </span>
      <span>
        <span>调用</span>
      </span>
      <span>
        <span>submitStage,</span>
      </span>
      <span>
        <span>通过</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>之间的依赖关系得出</span>
      </span>
      <span>
        <span>stageDAG</span>
      </span>
      <span>
        <span>，并以依赖关系进行处理：</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>idToActiveJob</span>
        <span>(</span>
        <span>jobId</span>
        <span>)=</span>
        <span>job</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>activeJobs</span>
        <span>+=</span>
        <span>job</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>resultStageToJob</span>
        <span>(</span>
        <span>finalStage</span>
        <span>)=</span>
        <span>job</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>listenerBus</span>
        <span>.post(SparkListenerJobStart(</span>
        <span>job</span>
        <span>,</span>
        <span>jobIdToStageIds</span>
        <span>(</span>
        <span>jobId</span>
        <span>).toArray,</span>
        <span>properties</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>submitStage(</span>
        <span>finalStage</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>submitStage</span>
      </span>
      <span>
        <span>方法处理流程：</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>private</strong>
          </span>
          <span>
            <strong>def</strong>
          </span>
          submitStage(stage: Stage) {        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>jobId</span>
        <span>=activeJobForStage(stage)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(</span>
        <span>jobId</span>
        <span>.isDefined){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logDebug(</span>
        <span>"submitStage("</span>
        <span>+ stage +</span>
        <span>")"</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(!</span>
        <span>
          <u>waiting</u>
        </span>
        <span>(stage)&amp;&amp; !</span>
        <span>running</span>
        <span>(stage)&amp;&amp; !</span>
        <span>failed</span>
        <span>(stage)){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>missing</span>
        <span>=getMissingParentStages(stage).sortBy(_.</span>
        <span>id</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logDebug(</span>
        <span>"missing:"</span>
        <span>+</span>
        <span>missing</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(</span>
        <span>missing</span>
        <span>==Nil) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>"Submitting"</span>
        <span>+ stage +</span>
        <span>"("</span>
        <span>+ stage.</span>
        <span>rdd</span>
        <span>+</span>
        <span>"), which has no missingparents"</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>submitMissingTasks(stage,</span>
        <span>jobId</span>
        <span>.get)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>running</span>
        <span>+= stage</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
        <span>
          <strong>else</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>for</strong>
        </span>
        <span>(</span>
        <span>parent</span>
        <span>&lt;-</span>
        <span>missing</span>
        <span>) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>submitStage(</span>
        <span>parent</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>waiting</span>
        <span>+= stage</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
        <span>
          <strong>else</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>abortStage(stage,</span>
        <span>"Noactive job for stage "</span>
        <span>+ stage.</span>
        <span>id</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>对于一个刚生成的</span>
      </span>
      <span>
        <span>job,</span>
      </span>
      <span>
        <span>此时的</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>为刚生成，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>此时</span>
      </span>
      <span>
        <span>submitStage</span>
      </span>
      <span>
        <span>调用</span>
      </span>
      <span>
        <span>getMissingParentStages</span>
      </span>
      <span>
        <span>得到</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>parent,</span>
      </span>
      <span>
        <span>也就是</span>
      </span>
      <span>
        <span>RDD</span>
      </span>
      <span>
        <span>的依赖关系</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>生成</span>
      </span>
      <span>
        <span>parentStage</span>
      </span>
      <span>
        <span>是通过</span>
      </span>
      <span>
        <span>RDD</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>dependencies</span>
      </span>
      <span>
        <span>来生成相关的</span>
      </span>
      <span>
        <span>RDD</span>
      </span>
      <span>
        <span>的依赖关系，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>如果依赖关系是</span>
      </span>
      <span>
        <span>ShuffleDependency</span>
      </span>
      <span>
        <span>，生成一个</span>
      </span>
      <span>
        <span>mapStage</span>
      </span>
      <span>
        <span>来作为</span>
      </span>
      <span>
        <span>finalStage</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>parent,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>否则是</span>
      </span>
      <span>
        <span>NarrowDependency</span>
      </span>
      <span>
        <span>，不生成新的</span>
      </span>
      <span>
        <span>stage.</span>
      </span>
      <span>
        <span>如</span>
      </span>
      <span>
        <span>count</span>
      </span>
      <span>
        <span>，各</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>没有相关的数据依赖</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>也就是说，对应需要执行</span>
      </span>
      <span>
        <span>shuffle</span>
      </span>
      <span>
        <span>操作的</span>
      </span>
      <span>
        <span>job,</span>
      </span>
      <span>
        <span>会生成</span>
      </span>
      <span>
        <span>mapStage</span>
      </span>
      <span>
        <span>与</span>
      </span>
      <span>
        <span>finalStage</span>
      </span>
      <span>
        <span>进行，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>而不需要</span>
      </span>
      <span>
        <span>shuffle</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>job</span>
      </span>
      <span>
        <span>只需要一个</span>
      </span>
      <span>
        <span>finalStage</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>private</strong>
          </span>
          <span>
            <strong>def</strong>
          </span>
          getMissingParentStages(stage:Stage): List[Stage] = {        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>missing</span>
        <span>=</span>
        <span>
          <strong>new</strong>
        </span>
        <span>HashSet[Stage]</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>visited</span>
        <span>=</span>
        <span>
          <strong>new</strong>
        </span>
        <span>HashSet[RDD[_]]</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>def</strong>
        </span>
        <span>visit(rdd: RDD[_]) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(!</span>
        <span>visited</span>
        <span>(rdd)){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>visited</span>
        <span>+= rdd</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(</span>
        <span>
          <u>getCacheLocs</u>
        </span>
        <span>
          <u>(rdd)</u>
        </span>
        <span>.contains(Nil)){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>for</strong>
        </span>
        <span>(</span>
        <span>dep</span>
        <span>&lt;-rdd.dependencies) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>dep</span>
        <span>
          <strong>match</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>case</strong>
        </span>
        <span>shufDep</span>
        <span>:ShuffleDependency[_,_] =&gt;</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>mapStage</span>
        <span>=getShuffleMapStage(</span>
        <span>shufDep</span>
        <span>,stage.</span>
        <span>jobId</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(!</span>
        <span>mapStage</span>
        <span>.isAvailable){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>missing</span>
        <span>+=</span>
        <span>mapStage</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>case</strong>
        </span>
        <span>narrowDep</span>
        <span>:NarrowDependency[_] =&gt;</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>visit(</span>
        <span>narrowDep</span>
        <span>.</span>
        <span>rdd</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>visit(stage.</span>
        <span>rdd</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>missing</span>
        <span>.toList</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>接下来回到</span>
      </span>
      <span>
        <span>submitStage</span>
      </span>
      <span>
        <span>方法中</span>
      </span>
      <span>
        <span>,</span>
      </span>
      <span>
        <span>如果</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>没有</span>
      </span>
      <span>
        <span>missing</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>时</span>
      </span>
      <span>
        <span>(</span>
      </span>
      <span>
        <span>没有</span>
      </span>
      <span>
        <span>parentstage)</span>
      </span>
      <span>
        <span>，执行</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>的提交操作。</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>if</strong>
          </span>
          (          <span>missing</span>
          == Nil) {        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>"Submitting"</span>
        <span>+ stage +</span>
        <span>"("</span>
        <span>+ stage.</span>
        <span>rdd</span>
        <span>+</span>
        <span>"), which has no missingparents"</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>submitMissingTasks(stage,</span>
        <span>jobId</span>
        <span>.get)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>设置当前的</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>为</span>
      </span>
      <span>
        <span>running,</span>
      </span>
      <span>
        <span>因为当前的</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>没有</span>
      </span>
      <span>
        <span>parent</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>stage,</span>
      </span>
      <span>
        <span>直接</span>
      </span>
      <span>
        <span>running</span>
      </span>
      <span>
        <span>当前的</span>
      </span>
      <span>
        <span>stage</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>running</span>
        <span>+= stage</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          }          <span>
            <strong>else</strong>
          </span>
          {        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>for</strong>
        </span>
        <span>(</span>
        <span>parent</span>
        <span>&lt;-</span>
        <span>missing</span>
        <span>) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>此</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>中包含有</span>
      </span>
      <span>
        <span>parent</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>stage,</span>
      </span>
      <span>
        <span>因此</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>需要进行顺序执行。先执行</span>
      </span>
      <span>
        <span>parent</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>stage.</span>
      </span>
      <span>
        <span>递归调用</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>submitStage(</span>
        <span>parent</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>设置当前的</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>为</span>
      </span>
      <span>
        <span>waiting,</span>
      </span>
      <span>
        <span>表示此</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>需要等待</span>
      </span>
      <span>
        <span>parent</span>
      </span>
      <span>
        <span>的执行完成。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>waiting</span>
        <span>+= stage</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>执行</span>
      </span>
      <span>
        <span>submitMissingTasks</span>
      </span>
      <span>
        <span>流程处理，把</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>根据</span>
      </span>
      <span>
        <span>partition</span>
      </span>
      <span>
        <span>生成</span>
      </span>
      <span>
        <span>TaskSet,</span>
      </span>
      <span>
        <span>通过</span>
      </span>
      <span>
        <span>TaskScheduler</span>
      </span>
      <span>
        <span>提交</span>
      </span>
      <span>
        <span>Task.</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>private</strong>
          </span>
          <span>
            <strong>def</strong>
          </span>
          submitMissingTasks(stage:Stage, jobId: Int) {        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>logDebug(</span>
        <span>"submitMissingTasks("</span>
        <span>+ stage +</span>
        <span>")"</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//Get our pending tasks and remember them in our pendingTasks entry</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>myPending</span>
        <span>=</span>
        <span>pendingTasks</span>
        <span>.getOrElseUpdate(stage,</span>
        <span>
          <strong>new</strong>
        </span>
        <span>HashSet)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>myPending</span>
        <span>.clear()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>var</strong>
        </span>
        <span>tasks</span>
        <span>=ArrayBuffer[Task[_]]()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>检查</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>是否是</span>
      </span>
      <span>
        <span>mapStage,</span>
      </span>
      <span>
        <span>如果是</span>
      </span>
      <span>
        <span>shuffleMapStage,</span>
      </span>
      <span>
        <span>生成</span>
      </span>
      <span>
        <span>ShuffleMapTask,</span>
      </span>
      <span>
        <span>并添加到</span>
      </span>
      <span>
        <span>tasks</span>
      </span>
      <span>
        <span>列表中。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>mapStage</span>
      </span>
      <span>
        <span>表示还有其它</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>依赖此</span>
      </span>
      <span>
        <span>stage</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(stage.</span>
        <span>isShuffleMap</span>
        <span>){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>for</strong>
        </span>
        <span>(</span>
        <span>p</span>
        <span>&lt;-</span>
        <span>
          <u>0</u>
        </span>
        <span>until stage.</span>
        <span>numPartitions</span>
        <span>
          <strong>if</strong>
        </span>
        <span>stage.</span>
        <span>outputLocs</span>
        <span>(p)== Nil) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>得到</span>
      </span>
      <span>
        <span>rddstage</span>
      </span>
      <span>
        <span>中当前传入的</span>
      </span>
      <span>
        <span>partition</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>TaskLocation(</span>
      </span>
      <span>
        <span>也就是</span>
      </span>
      <span>
        <span>Taskhost)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>locs</span>
        <span>=getPreferredLocs(stage.</span>
        <span>rdd</span>
        <span>,</span>
        <span>p</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>tasks</span>
        <span>+=</span>
        <span>
          <strong>new</strong>
        </span>
        <span>ShuffleMapTask(stage.</span>
        <span>id</span>
        <span>,stage.</span>
        <span>rdd</span>
        <span>,stage.</span>
        <span>shuffleDep</span>
        <span>.get,</span>
        <span>p</span>
        <span>,</span>
        <span>locs</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
        <span>
          <strong>else</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>否则表示是一个</span>
      </span>
      <span>
        <span>finalStage,</span>
      </span>
      <span>
        <span>此类</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>直接输出结果，生成</span>
      </span>
      <span>
        <span>ResultTask,</span>
      </span>
      <span>
        <span>并添加到</span>
      </span>
      <span>
        <span>tasks</span>
      </span>
      <span>
        <span>列表中。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//This is a final stage; figure out its job's missing partitions</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>job</span>
        <span>=</span>
        <span>resultStageToJob</span>
        <span>(stage)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>for</strong>
        </span>
        <span>(</span>
        <span>id</span>
        <span>&lt;-</span>
        <span>
          <u>0</u>
        </span>
        <span>until</span>
        <span>job</span>
        <span>.</span>
        <span>numPartitions</span>
        <span>
          <strong>if</strong>
        </span>
        <span>!</span>
        <span>job</span>
        <span>.</span>
        <span>finished</span>
        <span>(id)){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>partition</span>
        <span>=</span>
        <span>job</span>
        <span>.</span>
        <span>partitions</span>
        <span>(</span>
        <span>id</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>得到</span>
      </span>
      <span>
        <span>rddstage</span>
      </span>
      <span>
        <span>中当前传入的</span>
      </span>
      <span>
        <span>partition</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>TaskLocation(</span>
      </span>
      <span>
        <span>也就是</span>
      </span>
      <span>
        <span>Taskhost)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>locs</span>
        <span>=getPreferredLocs(stage.</span>
        <span>rdd</span>
        <span>,</span>
        <span>partition</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>tasks</span>
        <span>+=</span>
        <span>
          <strong>new</strong>
        </span>
        <span>ResultTask(stage.</span>
        <span>id</span>
        <span>,stage.</span>
        <span>rdd</span>
        <span>,</span>
        <span>job</span>
        <span>.</span>
        <span>func</span>
        <span>,</span>
        <span>partition</span>
        <span>,</span>
        <span>locs</span>
        <span>,</span>
        <span>id</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>properties</span>
        <span>=</span>
        <span>
          <strong>if</strong>
        </span>
        <span>(</span>
        <span>idToActiveJob</span>
        <span>.contains(jobId)){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>idToActiveJob</span>
        <span>(stage.</span>
        <span>jobId</span>
        <span>).</span>
        <span>properties</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
        <span>
          <strong>else</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//thisstage will be assigned to "default" pool</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>null</strong>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//must be run listener before possible NotSerializableException</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//should be "StageSubmitted" first and then "JobEnded"</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>listenerBus</span>
        <span>.post(SparkListenerStageSubmitted(</span>
        <span>stageToInfos</span>
        <span>(stage),</span>
        <span>properties</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>如果有生成的</span>
    </span>
    <span>
      <span>tasks,</span>
    </span>
    <span>
      <span>也就是此</span>
    </span>
    <span>
      <span>job</span>
    </span>
    <span>
      <span>中有需要执行的</span>
    </span>
    <span>
      <span>task,</span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(</span>
        <span>tasks</span>
        <span>.size&gt;</span>
        <span>0</span>
        <span>) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//Preemptively serialize a task to make sure it can be serialized. Weare catching this</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//exception here because it would be fairly hard to catch thenon-</span>
        <span>
          <u>serializable</u>
        </span>
        <span>exception</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//down the road, where we have several different implementations forlocal scheduler and</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//cluster schedulers.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>try</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>SparkEnv.get.</span>
        <span>closureSerializer</span>
        <span>.newInstance().serialize(</span>
        <span>tasks</span>
        <span>.head)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
        <span>
          <strong>catch</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>case</strong>
        </span>
        <span>e</span>
        <span>:NotSerializableException =&gt;</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>abortStage(stage,</span>
        <span>"Tasknot serializable: "</span>
        <span>+</span>
        <span>e</span>
        <span>.toString)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>running</span>
        <span>-= stage</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>return</strong>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>"Submitting"</span>
        <span>+</span>
        <span>tasks</span>
        <span>.size+</span>
        <span>" missing tasks from "</span>
        <span>+ stage +</span>
        <span>" ("</span>
        <span>+ stage.</span>
        <span>rdd</span>
        <span>+</span>
        <span>")"</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>myPending</span>
        <span>++=</span>
        <span>tasks</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logDebug(</span>
        <span>"Newpending tasks: "</span>
        <span>+</span>
        <span>myPending</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>执行</span>
      </span>
    </span>
    <span>
      <span>
        <span>TaskScheduler.submitTasks</span>
      </span>
    </span>
    <span>
      <span>
        <span>处理函数，</span>
      </span>
    </span>
    <span>
      <span>
        <span>TaskScheduler</span>
      </span>
    </span>
    <span>
      <span>
        <span>的实现在</span>
      </span>
    </span>
    <span>
      <span>
        <span>onyarn</span>
      </span>
    </span>
    <span>
      <span>
        <span>中为</span>
      </span>
    </span>
    <span>
      <span>
        <span>YarnClusterScheduler</span>
        <span>.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>请参见下面的</span>
      </span>
      <span>
        <span>TaskScheduler</span>
      </span>
      <span>
        <span>提交</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>流程分析</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>taskSched.submitTasks(</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>new</strong>
        </span>
        <span>TaskSet(</span>
        <span>tasks</span>
        <span>.toArray,stage.</span>
        <span>id</span>
        <span>,stage.newAttemptId(), stage.</span>
        <span>jobId</span>
        <span>,</span>
        <span>properties</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>stageToInfos</span>
        <span>(stage).</span>
        <span>submissionTime</span>
        <span>= Some(System.currentTimeMillis())</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
        <span>
          <strong>else</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logDebug(</span>
        <span>"Stage"</span>
        <span>+ stage +</span>
        <span>
          <u>"is actually done; %b %d %d"</u>
        </span>
        <span>.format(</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>stage.isAvailable,stage.</span>
        <span>numAvailableOutputs</span>
        <span>,stage.</span>
        <span>numPartitions</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>running</span>
        <span>-= stage</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>到目前为此，</span>
      </span>
      <span>
        <span>job</span>
      </span>
      <span>
        <span>在</span>
      </span>
      <span>
        <span>DAGScheduler</span>
      </span>
      <span>
        <span>的处理流程完成。等待</span>
      </span>
      <span>
        <span>TaskScheduler</span>
      </span>
      <span>
        <span>处理完数据后，回调</span>
      </span>
      <span>
        <span>DAGScheduler.</span>
      </span>
    </span>
  </p>
  <h3>
    TaskScheduler    <span>提交</span>
    task    <span>流程分析</span>
  </h3>
  <p>
    <font>
      <span>
        <span>TaskScheduler</span>
      </span>
      <span>
        <span>在</span>
      </span>
      <span>
        <span>onyarn</span>
      </span>
      <span>
        <span>模式时</span>
      </span>
      <span>
        <span>,</span>
      </span>
      <span>
        <span>实现为</span>
      </span>
      <span>
        <span>
          <span>YarnClusterScheduler</span>
        </span>
      </span>
      <span>
        <span>。提交</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>时，通过调用</span>
      </span>
      <span>
        <span>submitTasks</span>
      </span>
      <span>
        <span>函数。</span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>YarnClusterScheduler</span>
      </span>
      <span>
        <span>继承与</span>
      </span>
      <span>
        <span>TaskSchedulerImpl.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>通过</span>
      </span>
      <span>
        <span>TaskSchedulerImpl.submitTasks</span>
      </span>
      <span>
        <span>对</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>的提交进行处理。</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>override</strong>
          </span>
          <span>
            <strong>def</strong>
          </span>
          submitTasks(taskSet: TaskSet){        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>tasks</span>
        <span>=taskSet.</span>
        <span>tasks</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>"Addingtask set "</span>
        <span>+ taskSet.</span>
        <span>id</span>
        <span>+</span>
        <span>" with "</span>
        <span>+</span>
        <span>tasks</span>
        <span>.length+</span>
        <span>" tasks"</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>this</strong>
        </span>
        <span>.synchronized{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>生成一个</span>
      </span>
      <span>
        <span>TaskSetManager</span>
      </span>
      <span>
        <span>实例，并把此实例设置到</span>
      </span>
      <span>
        <span>activeTaskSets</span>
      </span>
      <span>
        <span>的容器中。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>在生成实例的过程中，会把</span>
      </span>
      <span>
        <span>taskSet</span>
      </span>
      <span>
        <span>传入，并得到要执行的</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>个数，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>并根据</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>location</span>
      </span>
      <span>
        <span>信息</span>
      </span>
      <span>
        <span>,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>生成副本执行次数的容器</span>
      </span>
    </span>
    <span>
      <span>
        <span>copiesRunning</span>
      </span>
    </span>
    <span>
      <span>
        <span>，列表的个数为</span>
      </span>
    </span>
    <span>
      <span>
        <span>job</span>
      </span>
    </span>
    <span>
      <span>
        <span>中</span>
      </span>
    </span>
    <span>
      <span>
        <span>task</span>
      </span>
    </span>
    <span>
      <span>
        <span>的个数，所有的列表值为</span>
      </span>
    </span>
    <span>
      <span>
        <span>0</span>
      </span>
    </span>
    <span>
      <span>
        <span>，表示没有副本执行</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>把</span>
      </span>
    </span>
    <span>
      <span>
        <span>task</span>
      </span>
    </span>
    <span>
      <span>
        <span>分别放到</span>
      </span>
    </span>
    <span>
      <span>
        <span>
          <span>pendingTasksForExecutor(process_local)</span>
        </span>
      </span>
    </span>
    <span>
      <span>
        <span>
          <span>此时没有值，</span>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>/</span>
        <span>pendingTasksForHost(node_local),</span>
      </span>
    </span>
    <span>
      <span>
        <span>此时此节点的</span>
      </span>
    </span>
    <span>
      <span>
        <span>task</span>
      </span>
    </span>
    <span>
      <span>
        <span>全在此里面</span>
      </span>
    </span>
    <span>
      <span>
        <span>,host</span>
      </span>
    </span>
    <span>
      <span>
        <span>在</span>
      </span>
    </span>
    <span>
      <span>
        <span>worker</span>
      </span>
    </span>
    <span>
      <span>
        <span>注册时已经存在</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>/pendingTasksForRack(rack)/</span>
      </span>
      <span>
        <span>，通常情况不会有值</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>pendingTasksWithNoPrefs(</span>
      </span>
      <span>
        <span>待分配</span>
      </span>
      <span>
        <span>),</span>
      </span>
      <span>
        <span>通常情况不会有值。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>allPendingTasks(any)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <span>所有的</span>
        </span>
      </span>
    </span>
    <span>
      <span>
        <span>
          <span>task</span>
        </span>
      </span>
    </span>
    <span>
      <span>
        <span>
          <span>都在最后一个中</span>
        </span>
        <span>。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>manager</span>
        <span>=</span>
        <span>
          <strong>new</strong>
        </span>
        <span>TaskSetManager(</span>
        <span>
          <strong>this</strong>
        </span>
        <span>,taskSet,</span>
        <span>maxTaskFailures</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>activeTaskSets</span>
        <span>(taskSet.</span>
        <span>id</span>
        <span>)=</span>
        <span>manager</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>把</span>
      </span>
      <span>
        <span>TaskSetManager</span>
      </span>
      <span>
        <span>添加到</span>
      </span>
      <span>
        <span>rootPool</span>
      </span>
      <span>
        <span>中。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>schedulableBuilder</span>
        <span>.addTaskSetManager(</span>
        <span>manager</span>
        <span>,</span>
        <span>manager</span>
        <span>.</span>
        <span>taskSet</span>
        <span>.</span>
        <span>properties</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>针对此</span>
      </span>
      <span>
        <span>TaskSet(job)</span>
      </span>
      <span>
        <span>生成一个跟踪每一个</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>的容器</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>taskSetTaskIds</span>
        <span>(taskSet.</span>
        <span>id</span>
        <span>)=</span>
        <span>
          <strong>new</strong>
        </span>
        <span>HashSet[Long]()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>定时检查</span>
    </span>
    <span>
      <span>taskSet</span>
    </span>
    <span>
      <span>是否被启动，如果没有被启动，提示无资源，如果被启动成功，关闭此检查线程。</span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(!isLocal &amp;&amp; !</span>
        <span>hasReceivedTask</span>
        <span>){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>starvationTimer</span>
        <span>.scheduleAtFixedRate(</span>
        <span>
          <strong>new</strong>
        </span>
        <span>TimerTask() {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>override</strong>
        </span>
        <span>
          <strong>def</strong>
        </span>
        <span>run() {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(!</span>
        <span>hasLaunchedTask</span>
        <span>){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logWarning(</span>
        <span>"Initialjob has not accepted any resources; "</span>
        <span>+</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>"checkyour cluster UI to ensure that workers are registered "</span>
        <span>+</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>"andhave sufficient memory"</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
        <span>
          <strong>else</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>this</strong>
        </span>
        <span>.cancel()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>},</span>
        <span>STARVATION_TIMEOUT</span>
        <span>,</span>
        <span>STARVATION_TIMEOUT</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>hasReceivedTask</span>
        <span>=</span>
        <span>
          <strong>true</strong>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>通过</span>
      </span>
      <span>
        <span>backend</span>
      </span>
      <span>
        <span>发起执行消息</span>
      </span>
      <span>
        <span>,backend</span>
      </span>
      <span>
        <span>是</span>
      </span>
      <span>
        <span>SchedulerBackend</span>
      </span>
      <span>
        <span>的具体实现，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>在</span>
      </span>
      <span>
        <span>yarn-cluster</span>
      </span>
      <span>
        <span>模式为</span>
      </span>
      <span>
        <span>CoarseGrainedSchedulerBackend</span>
      </span>
      <span>
        <span>。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>backend</span>
        <span>.reviveOffers()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>CoarseGrainedSchedulerBackend.reviveOffers</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>通过</span>
      </span>
      <span>
        <span>driverActor</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>actor</span>
      </span>
      <span>
        <span>实例发起一个</span>
      </span>
      <span>
        <span>ReviveOffers</span>
      </span>
      <span>
        <span>的事件处理消息。</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>override</strong>
          </span>
          <span>
            <strong>def</strong>
          </span>
          reviveOffers() {        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>
          <u>driverActor</u>
        </span>
        <span>! ReviveOffers</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <span>
            <span>driverActor</span>
          </span>
        </span>
      </span>
      <span>
        <span>
          <span>
            <span>的实现为</span>
          </span>
        </span>
      </span>
      <span>
        <span>CoarseGrainedSchedulerBackend.DriverActor</span>
      </span>
      <span>
        <span>实例。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>DriverActor</span>
      </span>
      <span>
        <span>中处理</span>
      </span>
      <span>
        <span>revive</span>
      </span>
      <span>
        <span>的函数为</span>
      </span>
      <span>
        <span>receive.</span>
      </span>
      <span>
        <span>其中，处理</span>
      </span>
      <span>
        <span>ReviveOffers</span>
      </span>
      <span>
        <span>部分定义如下：</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>case</strong>
          </span>
          ReviveOffers =&gt;        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>makeOffers()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>最终调用的</span>
      </span>
      <span>
        <span>makeOffers</span>
      </span>
      <span>
        <span>函数。</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>def</strong>
          </span>
          makeOffers() {        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>executorHost</span>
      </span>
      <span>
        <span>与</span>
      </span>
      <span>
        <span>freeCores</span>
      </span>
      <span>
        <span>的值由来请查看</span>
      </span>
      <span>
        <span>appmaster</span>
      </span>
      <span>
        <span>启动时的补充</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>launchTasks(scheduler.resourceOffers(</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <u>executorHost</u>
        </span>
        <span>
          <u>.toArray</u>
        </span>
        <span>.map{</span>
        <span>
          <strong>case</strong>
        </span>
        <span>(</span>
        <span>id</span>
        <span>,</span>
        <span>host</span>
        <span>)=&gt;</span>
        <span>
          <strong>new</strong>
        </span>
        <span>WorkerOffer(</span>
        <span>id</span>
        <span>,</span>
        <span>host</span>
        <span>,</span>
        <span>freeCores</span>
        <span>(</span>
        <span>id</span>
        <span>))}))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>通过</span>
      </span>
      <span>
        <span>CoarseGrainedSchedulerBackend</span>
      </span>
      <span>
        <span>对应的</span>
      </span>
      <span>
        <span>scheduler(TaskSchdulerImpl).resourceOffers</span>
      </span>
      <span>
        <span>得到</span>
      </span>
      <span>
        <span>tasks</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>def</strong>
          </span>
          resourceOffers(offers: Seq[WorkerOffer]): Seq[Seq[TaskDescription]] =synchronized {        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>SparkEnv.set(</span>
        <span>sc</span>
        <span>.</span>
        <span>env</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//Mark each slave as alive and remember its</span>
        <span>
          <u>hostname</u>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>for</strong>
        </span>
        <span>(</span>
        <span>o</span>
        <span>&lt;-offers) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>把</span>
      </span>
      <span>
        <span>executor(worker)</span>
      </span>
      <span>
        <span>对应的</span>
      </span>
      <span>
        <span>host</span>
      </span>
      <span>
        <span>存储到对应的容器中</span>
      </span>
      <span>
        <span>,</span>
      </span>
      <span>
        <span>通过</span>
      </span>
      <span>
        <span>executorid</span>
      </span>
      <span>
        <span>拿</span>
      </span>
      <span>
        <span>host</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>executorIdToHost</span>
        <span>(</span>
        <span>o</span>
        <span>.</span>
        <span>executorId</span>
        <span>)=</span>
        <span>o</span>
        <span>.</span>
        <span>host</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>得到当前所有注册的</span>
      </span>
      <span>
        <span>worker</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>host,</span>
      </span>
      <span>
        <span>写入到对应的容器中</span>
      </span>
      <span>
        <span>,</span>
      </span>
      <span>
        <span>此容器表示</span>
      </span>
      <span>
        <span>node_local</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(!</span>
        <span>executorsByHost</span>
        <span>.contains(</span>
        <span>o</span>
        <span>.</span>
        <span>host</span>
        <span>)){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>executorsByHost</span>
        <span>(</span>
        <span>o</span>
        <span>.</span>
        <span>host</span>
        <span>)=</span>
        <span>
          <strong>new</strong>
        </span>
        <span>HashSet[String]()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>通过</span>
      </span>
      <span>
        <span>DAGScheduler.executorGained</span>
      </span>
      <span>
        <span>把</span>
      </span>
      <span>
        <span>executorId</span>
      </span>
      <span>
        <span>与</span>
      </span>
      <span>
        <span>host</span>
      </span>
      <span>
        <span>进行处理</span>
      </span>
      <span>
        <span>,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>请参见下面</span>
      </span>
      <span>
        <span>DAGScheduler</span>
      </span>
      <span>
        <span>中处理</span>
      </span>
      <span>
        <span>ExecutorGained</span>
      </span>
      <span>
        <span>处理。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>executorGained(</span>
        <span>o</span>
        <span>.</span>
        <span>executorId</span>
        <span>,</span>
        <span>o</span>
        <span>.</span>
        <span>host</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>根据所有的</span>
    </span>
    <span>
      <span>worker,</span>
    </span>
    <span>
      <span>根据每一个</span>
    </span>
    <span>
      <span>worker</span>
    </span>
    <span>
      <span>的的</span>
    </span>
    <span>
      <span>cpucore</span>
    </span>
    <span>
      <span>，生成</span>
    </span>
    <span>
      <span>[arraybuffer[]]</span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//Build a list of tasks to assign to each worker</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>tasks</span>
        <span>=offers.map(o =&gt;</span>
        <span>
          <strong>new</strong>
        </span>
        <span>ArrayBuffer[TaskDescription](o.</span>
        <span>cores</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>得到每一个</span>
      </span>
      <span>
        <span>worker</span>
      </span>
      <span>
        <span>可用的</span>
      </span>
      <span>
        <span>cpu</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>availableCpus</span>
        <span>= offers.map(o =&gt; o.</span>
        <span>cores</span>
        <span>).toArray</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>得到</span>
      </span>
      <span>
        <span>rootPool</span>
      </span>
      <span>
        <span>中排序后的队列中的所有的</span>
      </span>
      <span>
        <span>TaskSet</span>
      </span>
      <span>
        <span>存储的</span>
      </span>
      <span>
        <span>TaskSetMansger</span>
      </span>
      <span>
        <span>数组</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>sortedTaskSets</span>
        <span>=</span>
        <span>rootPool</span>
        <span>.getSortedTaskSetQueue()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>for</strong>
        </span>
        <span>(</span>
        <span>taskSet</span>
        <span>&lt;-</span>
        <span>sortedTaskSets</span>
        <span>){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logDebug(</span>
        <span>
          <u>"parentName:%s, name: %s, runningTasks: %s"</u>
        </span>
        <span>.format(</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>taskSet</span>
        <span>.</span>
        <span>parent</span>
        <span>.</span>
        <span>name</span>
        <span>,</span>
        <span>taskSet</span>
        <span>.</span>
        <span>name</span>
        <span>,</span>
        <span>taskSet</span>
        <span>.</span>
        <span>runningTasks</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//Take each TaskSet in our scheduling order, and then offer it eachnode in increasing order</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//of locality levels so that it gets a chance to launch local tasks onall of them.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>var</strong>
        </span>
        <span>launchedTask</span>
        <span>=</span>
        <span>
          <strong>false</strong>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>迭代出每一个</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>TaskSetMansger,</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>同时根据每一个</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>TaskSetMansger,</strong>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>迭代去按网络的优先级执行</strong>
        </span>
      </span>
    </span>
    <span>
      <span>
        <span>
          <strong>PROCESS_LOCAL</strong>
        </span>
        <span>
          <strong>,</strong>
        </span>
        <span>
          <strong>NODE_LOCAL</strong>
        </span>
        <span>
          <strong>,</strong>
        </span>
        <span>
          <strong>RACK_LOCAL</strong>
        </span>
        <span>
          <strong>,</strong>
        </span>
        <span>
          <strong>ANY</strong>
        </span>
      </span>
    </span>
    <span>
      <span>
        <span>
          <strong>。</strong>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>scala</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>中的</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>for</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>如果包含多个执行器，也就是</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>&lt;-</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>的表达式，多个用</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>;</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>号分开，后面一个优先前面一个执行</strong>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>也就是后一个执行完成后，相当于一个嵌套的</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>for</strong>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>此处开始执行对</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>taskSet</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>的执行节点选择，针对每一个</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>taskset,</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>首先使用</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>PROCESS_LOCAL</strong>
        </span>
      </span>
      <span>
        <span>
          <strong>开始。</strong>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>for</strong>
        </span>
        <span>(</span>
        <span>taskSet</span>
        <span>&lt;-</span>
        <span>sortedTaskSets</span>
        <span>;</span>
        <span>maxLocality</span>
        <span>&lt;- TaskLocality.values) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>do</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>迭代所有的</span>
      </span>
      <span>
        <span>worker,</span>
      </span>
      <span>
        <span>并在每迭代出一个</span>
      </span>
      <span>
        <span>worker</span>
      </span>
      <span>
        <span>时，在此机器上生成执行</span>
      </span>
      <span>
        <span>taskSet</span>
      </span>
      <span>
        <span>中对应的相关</span>
      </span>
      <span>
        <span>task</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>针对</span>
      </span>
      <span>
        <span>TaskSetmanager.resourceOffer</span>
      </span>
      <span>
        <span>的处理流程，见后面的细节分析，现在不分析此实现。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>launchedTask</span>
        <span>=</span>
        <span>
          <strong>false</strong>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>for</strong>
        </span>
        <span>(</span>
        <span>i</span>
        <span>&lt;-</span>
        <span>
          <u>0</u>
        </span>
        <span>until offers.size) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>execId</span>
        <span>=offers(</span>
        <span>i</span>
        <span>).</span>
        <span>executorId</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>host</span>
        <span>=offers(</span>
        <span>i</span>
        <span>).</span>
        <span>host</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>生成</span>
      </span>
    </span>
    <span>
      <span>
        <span>task</span>
      </span>
    </span>
    <span>
      <span>
        <span>执行的节点信息等，每次执行</span>
      </span>
    </span>
    <span>
      <span>
        <span>resourceOffer</span>
      </span>
    </span>
    <span>
      <span>
        <span>生成一个</span>
      </span>
    </span>
    <span>
      <span>
        <span>TaskDescription</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>把</span>
      </span>
    </span>
    <span>
      <span>
        <span>task</span>
      </span>
    </span>
    <span>
      <span>
        <span>对应的</span>
      </span>
    </span>
    <span>
      <span>
        <span>executorid</span>
      </span>
    </span>
    <span>
      <span>
        <span>与</span>
      </span>
    </span>
    <span>
      <span>
        <span>host</span>
      </span>
    </span>
    <span>
      <span>
        <span>添加到对应的</span>
      </span>
    </span>
    <span>
      <span>
        <span>activeExecutorIds</span>
      </span>
    </span>
    <span>
      <span>
        <span>与</span>
      </span>
    </span>
    <span>
      <span>
        <span>executorsByHost</span>
      </span>
    </span>
    <span>
      <span>
        <span>。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>for</strong>
        </span>
        <span>(</span>
        <span>task</span>
        <span>&lt;-</span>
        <span>taskSet</span>
        <span>.resourceOffer(</span>
        <span>execId</span>
        <span>,</span>
        <span>host</span>
        <span>,</span>
        <span>availableCpus</span>
        <span>(</span>
        <span>i</span>
        <span>),</span>
        <span>maxLocality</span>
        <span>)){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>tasks</span>
        <span>(</span>
        <span>i</span>
        <span>)+=</span>
        <span>task</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>tid</span>
        <span>=</span>
        <span>task</span>
        <span>.</span>
        <span>taskId</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>taskIdToTaskSetId</span>
        <span>(</span>
        <span>tid</span>
        <span>)=</span>
        <span>taskSet</span>
        <span>.</span>
        <span>taskSet</span>
        <span>.</span>
        <span>id</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>taskSetTaskIds</span>
        <span>(</span>
        <span>taskSet</span>
        <span>.</span>
        <span>taskSet</span>
        <span>.</span>
        <span>id</span>
        <span>)+=</span>
        <span>tid</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>taskIdToExecutorId</span>
        <span>(</span>
        <span>tid</span>
        <span>)=</span>
        <span>execId</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>此时把</span>
      </span>
    </span>
    <span>
      <span>
        <span>activeExecutorIds</span>
      </span>
    </span>
    <span>
      <span>
        <span>的值添加一个正在执行的</span>
      </span>
    </span>
    <span>
      <span>
        <span>executor,</span>
      </span>
    </span>
    <span>
      <span>
        <span>这个值的作用是当有多个</span>
      </span>
    </span>
    <span>
      <span>
        <span>stage</span>
      </span>
    </span>
    <span>
      <span>
        <span>的依赖时，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>下一个</span>
      </span>
    </span>
    <span>
      <span>
        <span>stage</span>
      </span>
    </span>
    <span>
      <span>
        <span>在执行</span>
      </span>
    </span>
    <span>
      <span>
        <span>submitTasks</span>
      </span>
    </span>
    <span>
      <span>
        <span>时，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>生成的</span>
      </span>
    </span>
    <span>
      <span>
        <span>TaskSetManager</span>
      </span>
    </span>
    <span>
      <span>
        <span>中会把新</span>
      </span>
    </span>
    <span>
      <span>
        <span>stage</span>
      </span>
    </span>
    <span>
      <span>
        <span>对应的</span>
      </span>
    </span>
    <span>
      <span>
        <span>task</span>
      </span>
    </span>
    <span>
      <span>
        <span>的</span>
      </span>
    </span>
    <span>
      <span>
        <span>executor</span>
      </span>
    </span>
    <span>
      <span>
        <span>直接使用此</span>
      </span>
    </span>
    <span>
      <span>
        <span>executor,</span>
      </span>
    </span>
    <span>
      <span>
        <span>也就是</span>
      </span>
    </span>
    <span>
      <span>
        <span>PROCESS_LOCAL.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>activeExecutorIds</span>
        <span>+=</span>
        <span>execId</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>executorsByHost</span>
        <span>(</span>
        <span>host</span>
        <span>)+=</span>
        <span>execId</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>availableCpus(i) -=</span>
        <span>1</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>launchedTask</span>
        <span>=</span>
        <span>
          <strong>true</strong>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>通</span>
      </span>
      <span>
        <span>TaskLocality</span>
      </span>
      <span>
        <span>，如果在一个较小的</span>
      </span>
      <span>
        <span>locality</span>
      </span>
      <span>
        <span>时找到一个</span>
      </span>
      <span>
        <span>task,</span>
      </span>
      <span>
        <span>从这个</span>
      </span>
      <span>
        <span>locality</span>
      </span>
      <span>
        <span>中接着找，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>否则跳出去从下一个</span>
      </span>
      <span>
        <span>locality</span>
      </span>
      <span>
        <span>重新找，放大</span>
      </span>
      <span>
        <span>locality</span>
      </span>
      <span>
        <span>的查找条件。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>如果</span>
      </span>
      <span>
        <span>launchedTask</span>
      </span>
      <span>
        <span>的值为</span>
      </span>
      <span>
        <span>true,</span>
      </span>
      <span>
        <span>表示在传入的</span>
      </span>
      <span>
        <span>locality</span>
      </span>
      <span>
        <span>级别上查找到</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>要执行对应的级别，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>那么在当前级别下接着去找到下一个可执行的</span>
      </span>
      <span>
        <span>TASK</span>
      </span>
      <span>
        <span>，否则</span>
      </span>
      <span>
        <span>launchedTask</span>
      </span>
      <span>
        <span>的值为</span>
      </span>
      <span>
        <span>false,</span>
      </span>
      <span>
        <span>放大一个</span>
      </span>
      <span>
        <span>locality</span>
      </span>
      <span>
        <span>的级别。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>如</span>
      </span>
      <span>
        <span>launchedTask</span>
      </span>
      <span>
        <span>的值为</span>
      </span>
      <span>
        <span>false,</span>
      </span>
      <span>
        <span>当前迭代的</span>
      </span>
      <span>
        <span>locality</span>
      </span>
      <span>
        <span>的级别为</span>
      </span>
      <span>
        <span>PROCESS_LOCAL,</span>
      </span>
      <span>
        <span>那么把级别放大到</span>
      </span>
      <span>
        <span>NODE_LOCAL</span>
      </span>
      <span>
        <span>重新查找</span>
      </span>
      <span>
        <span>.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
        <span>
          <strong>while</strong>
        </span>
        <span>(</span>
        <span>launchedTask</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>如果</span>
    </span>
    <span>
      <span>tasks</span>
    </span>
    <span>
      <span>生成成功，设置</span>
    </span>
    <span>
      <span>hasLaunchedTask</span>
    </span>
    <span>
      <span>的值为</span>
    </span>
    <span>
      <span>true,</span>
    </span>
    <span>
      <span>前面我们提到过的</span>
    </span>
    <span>
      <span>
        <span>submitTasks</span>
      </span>
    </span>
    <span>
      <span>
        <span>中的检查线程开始结束。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(</span>
        <span>tasks</span>
        <span>.size&gt;</span>
        <span>0</span>
        <span>) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>hasLaunchedTask</span>
        <span>=</span>
        <span>
          <strong>true</strong>
        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>返回生成成功的</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>列表。交给</span>
      </span>
      <span>
        <span>CoarseGrainedSchedulerBackend.launchTasks</span>
      </span>
      <span>
        <span>处理</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>return</strong>
        </span>
        <span>tasks</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>CoarseGrainedSchedulerBackend.launchTasks</span>
      </span>
      <span>
        <span>处理流程：</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>通过</span>
      </span>
      <span>
        <span>worker</span>
      </span>
      <span>
        <span>注册的</span>
      </span>
      <span>
        <span>actor,</span>
      </span>
      <span>
        <span>向</span>
      </span>
      <span>
        <span>CoarseGrainedExecutorBackend</span>
      </span>
      <span>
        <span>发送消息，处理</span>
      </span>
      <span>
        <span>LaunchTask</span>
      </span>
      <span>
        <span>事件</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>def</strong>
          </span>
          launchTasks(tasks: Seq[Seq[TaskDescription]]) {        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>for</strong>
        </span>
        <span>(</span>
        <span>task</span>
        <span>&lt;-tasks.flatten) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>freeCores(task.executorId) -=</span>
        <span>1</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <u>executorActor</u>
        </span>
        <span>
          <u>(</u>
        </span>
        <span>
          <u>task</u>
        </span>
        <span>
          <u>.</u>
        </span>
        <span>
          <u>executorId</u>
        </span>
        <span>
          <u>)</u>
        </span>
        <span>! LaunchTask(</span>
        <span>task</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>CoarseGrainedExecutorBackend</span>
      </span>
      <span>
        <span>中处理</span>
      </span>
      <span>
        <span>LaunchTask</span>
      </span>
      <span>
        <span>事件事件。</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>override</strong>
          </span>
          <span>
            <strong>def</strong>
          </span>
          receive = {        </span>
      </span>
    </font>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>case</strong>
          </span>
          LaunchTask(          <span>taskDesc</span>
          ) =&gt;        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>"Gotassigned task "</span>
        <span>+</span>
        <span>taskDesc</span>
        <span>.</span>
        <span>taskId</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(</span>
        <span>executor</span>
        <span>==</span>
        <span>
          <strong>null</strong>
        </span>
        <span>){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logError(</span>
        <span>"ReceivedLaunchTask command but executor was null"</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>System.exit(</span>
        <span>1</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
        <span>
          <strong>else</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>通过</span>
      </span>
      <span>
        <span>executor</span>
      </span>
      <span>
        <span>执行</span>
      </span>
      <span>
        <span>task,</span>
      </span>
      <span>
        <span>见后面的分析。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>executor</span>
        <span>.launchTask(</span>
        <span>
          <strong>this</strong>
        </span>
        <span>,</span>
        <span>taskDesc</span>
        <span>.</span>
        <span>taskId</span>
        <span>,</span>
        <span>taskDesc</span>
        <span>.serializedTask)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>TaskSetManager.resourceOffer</span>
      </span>
      <span>
        <span>函数，每次执行得到一个</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>的执行节点。</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>def</strong>
          </span>
          resourceOffer(        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>execId: String,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>host: String,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>availableCpus: Int,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>maxLocality:TaskLocality.TaskLocality)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>:Option[TaskDescription] =</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          {          <br>
        </span>
      </span>
      <span>
        <span>如果成功的</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>个数小于当前的</span>
      </span>
      <span>
        <span>job</span>
      </span>
      <span>
        <span>要执行的</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>的个数，</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>同时</span>
      </span>
      <span>
        <span>worker</span>
      </span>
      <span>
        <span>中可用的</span>
      </span>
      <span>
        <span>cpu</span>
      </span>
      <span>
        <span>资源需要大于或等于</span>
      </span>
      <span>
        <span>
          <span>spark.task.cpus</span>
        </span>
      </span>
      <span>
        <span>配置的值，默认需要大于或等于</span>
      </span>
      <span>
        <span>1.</span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(</span>
        <span>tasksSuccessful</span>
        <span>&lt;</span>
        <span>numTasks</span>
        <span>&amp;&amp; availableCpus &gt;=</span>
        <span>CPUS_PER_TASK</span>
        <span>){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>curTime</span>
        <span>=clock.getTime()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>得到一个默认的</span>
    </span>
    <span>
      <span>locality</span>
    </span>
    <span>
      <span>的值，默认情况下最有可能是</span>
    </span>
    <span>
      <span>NODE_LOCAL.</span>
    </span>
  </p>
  <p>
    <span>
      <span>此处根据上一次查找可执行节点的时间，得到一个合适此执行时间的一个</span>
    </span>
    <span>
      <span>locality</span>
    </span>
    <span>
      <span>级别。</span>
    </span>
  </p>
  <p>
    <span>
      <span>通过</span>
    </span>
    <font face="Monospace">
      <span>
        <span>
          <span>spark.locality.wait</span>
        </span>
      </span>
    </font>
    <span>
      <span>配置全局的等待时间。默认为</span>
    </span>
    <span>
      <span>3000ms</span>
    </span>
    <span>
      <span>。作用于</span>
    </span>
    <span>
      <span>PROCESS_LOCAL,NODE_LOCAL,RACK_LOCAL</span>
    </span>
  </p>
  <p>
    <span>
      <span>通过</span>
    </span>
    <font face="Monospace">
      <span>
        <span>
          <span>
            <u>spark.locality.wait.process</u>
          </span>
        </span>
      </span>
    </font>
    <span>
      <span>配置</span>
    </span>
    <span>
      <span>PROCESS_LOCAL</span>
    </span>
    <span>
      <span>的等待时间。</span>
    </span>
  </p>
  <p>
    <span>
      <span>通过</span>
    </span>
    <font face="Monospace">
      <span>
        <span>
          <span>
            <u>spark.locality.wait.node</u>
          </span>
        </span>
      </span>
    </font>
    <span>
      <span>配置</span>
    </span>
    <span>
      <span>NODE_LOCAL</span>
    </span>
    <span>
      <span>的等待时间。</span>
    </span>
  </p>
  <p>
    <span>
      <span>通过</span>
    </span>
    <font face="Monospace">
      <span>
        <span>
          <span>
            <u>spark.locality.wait.rack</u>
          </span>
        </span>
      </span>
    </font>
    <span>
      <span>配置</span>
    </span>
    <span>
      <span>RACK_LOCAL</span>
    </span>
    <span>
      <span>的等待时间。</span>
    </span>
  </p>
  <p>
    <span>
      <span>这里的查找方式是通过当前的</span>
    </span>
    <span>
      <span>
        <span>currentLocalityIndex</span>
      </span>
    </span>
    <span>
      <span>的值，默认从</span>
    </span>
    <span>
      <span>0</span>
    </span>
    <span>
      <span>开始，找到对应可执行的级别，</span>
    </span>
  </p>
  <p>
    <span>
      <span>检查当前时间减去上次的查找级别的执行时间是否大于上面配置的在此级别的执行时间，</span>
    </span>
  </p>
  <p>
    <span>
      <span>如果大于配置的时间，把</span>
    </span>
    <span>
      <span>
        <span>currentLocalityIndex</span>
      </span>
    </span>
    <span>
      <span>的值</span>
    </span>
    <span>
      <span>+1</span>
    </span>
    <span>
      <span>重新检查，返回一个合适的</span>
    </span>
    <span>
      <span>locality</span>
    </span>
    <span>
      <span>级别。</span>
    </span>
  </p>
  <p>
    <span>
      <span>如果执行查找的时间超过了以上配置的几个</span>
    </span>
    <span>
      <span>locality</span>
    </span>
    <span>
      <span>的级别的查找时间，此时返回的值为</span>
    </span>
    <span>
      <span>ANY.</span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>var</strong>
        </span>
        <span>allowedLocality</span>
        <span>= getAllowedLocalityLevel(</span>
        <span>curTime</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>首先把当前可执行的</span>
      </span>
    </span>
    <span>
      <span>
        <span>locality</span>
      </span>
    </span>
    <span>
      <span>
        <span>设置为</span>
      </span>
    </span>
    <span>
      <span>
        <span>PROCESS_LOCAL</span>
        <span>.maxLocality</span>
      </span>
    </span>
    <span>
      <span>
        <span>是最大的级别，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>得到的可执行级别不能超过此级别</span>
      </span>
      <span>
        <span>,</span>
      </span>
      <span>
        <span>从</span>
      </span>
      <span>
        <span>PROCESS_LOCAL</span>
      </span>
      <span>
        <span>开始一级一级向上加大。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>maxLocality</span>
      </span>
      <span>
        <span>的级别从</span>
      </span>
      <span>
        <span>PROCESS_LOCAL</span>
      </span>
      <span>
        <span>一级一级向上加，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>如果</span>
      </span>
      <span>
        <span>getAllowedLocalityLevel</span>
      </span>
      <span>
        <span>查找到的级别大于现在传入的级别。把级别设置为传入的级别。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>maxLocality</span>
      </span>
      <span>
        <span>传入按</span>
      </span>
      <span>
        <span>PROCESS_LOCAL/NODE_LOCAL/RACK_LOCAL/ANY</span>
      </span>
      <span>
        <span>进行传入。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(</span>
        <span>allowedLocality</span>
        <span>&gt; maxLocality) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>allowedLocality</span>
        <span>= maxLocality</span>
        <span>// We're not allowed tosearch for farther-away tasks</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>通过</span>
    </span>
    <span>
      <span>findTask</span>
    </span>
    <span>
      <span>来得到</span>
    </span>
    <span>
      <span>task</span>
    </span>
    <span>
      <span>对应的执行网络选择。</span>
    </span>
  </p>
  <p>
    <span>
      <span>见下面的</span>
    </span>
    <span>
      <span>
        <span>TaskSetManager.findTask</span>
      </span>
    </span>
    <span>
      <span>
        <span>选择</span>
      </span>
    </span>
    <span>
      <span>
        <span>task</span>
      </span>
    </span>
    <span>
      <span>
        <span>的执行节点的流程部分</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>findTask(execId, host,</span>
        <span>allowedLocality</span>
        <span>)</span>
        <span>
          <strong>match</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>case</strong>
        </span>
        <span>Some((</span>
        <span>index</span>
        <span>,</span>
        <span>taskLocality</span>
        <span>))=&gt; {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//Found a task; do some bookkeeping and return a task description</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>task</span>
        <span>=</span>
        <span>tasks</span>
        <span>(</span>
        <span>index</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>taskId</span>
        <span>=sched.newTaskId()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//Figure out whether this should count as a preferred launch</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>
          <u>"Startingtask %s:%d as TID %s on executor %s: %s (%s)"</u>
        </span>
        <span>.format(</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>taskSet</span>
        <span>.</span>
        <span>id</span>
        <span>,</span>
        <span>index</span>
        <span>,</span>
        <span>taskId</span>
        <span>,execId, host,</span>
        <span>taskLocality</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>设置</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>的执行副本加一，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//Do various bookkeeping</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>copiesRunning(index) +=</span>
        <span>1</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>info</span>
        <span>=</span>
        <span>
          <strong>new</strong>
        </span>
        <span>TaskInfo(</span>
        <span>taskId</span>
        <span>,</span>
        <span>index</span>
        <span>,</span>
        <span>curTime</span>
        <span>,execId, host,</span>
        <span>taskLocality</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>taskInfos</span>
        <span>(</span>
        <span>taskId</span>
        <span>)=</span>
        <span>info</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>taskAttempts</span>
        <span>(</span>
        <span>index</span>
        <span>)=</span>
        <span>info</span>
        <span>::</span>
        <span>taskAttempts</span>
        <span>(</span>
        <span>index</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>得到当前加载的节点执行级别的</span>
      </span>
    </span>
    <span>
      <span>
        <span>index,</span>
      </span>
    </span>
    <span>
      <span>
        <span>并更新当前查找此执行节点的查找时间为当前时间。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//Update our locality level for delay scheduling</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>currentLocalityIndex</span>
        <span>= getLocalityIndex(</span>
        <span>taskLocality</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>lastLaunchTime</span>
        <span>=</span>
        <span>curTime</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//Serialize and return the task</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>startTime</span>
        <span>=clock.getTime()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//We rely on the DAGScheduler to catch non-</span>
        <span>
          <u>serializable</u>
        </span>
        <span>closures and RDDs, so in here</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//we assume the task can be serialized without exceptions.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>serializedTask</span>
        <span>= Task.serializeWithDependencies(</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>task</span>
        <span>,sched.</span>
        <span>sc</span>
        <span>.</span>
        <span>addedFiles</span>
        <span>,sched.</span>
        <span>sc</span>
        <span>.</span>
        <span>addedJars</span>
        <span>,</span>
        <span>ser</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>timeTaken</span>
        <span>=clock.getTime() -</span>
        <span>startTime</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>把</span>
      </span>
    </span>
    <span>
      <span>
        <span>task</span>
      </span>
    </span>
    <span>
      <span>
        <span>添加到</span>
      </span>
    </span>
    <span>
      <span>
        <span>runningTasksSet</span>
      </span>
    </span>
    <span>
      <span>
        <span>的容器中。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>addRunningTask(</span>
        <span>taskId</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>
          <u>"Serializedtask %s:%d as %d bytes in %d ms"</u>
        </span>
        <span>.format(</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>taskSet</span>
        <span>.</span>
        <span>id</span>
        <span>,</span>
        <span>index</span>
        <span>,</span>
        <span>serializedTask</span>
        <span>.limit,</span>
        <span>timeTaken</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>taskName</span>
        <span>=</span>
        <span>
          <u>"task %s:%d"</u>
        </span>
        <span>.format(</span>
        <span>taskSet</span>
        <span>.</span>
        <span>id</span>
        <span>,</span>
        <span>index</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>如果</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>的执行尝试的值为</span>
      </span>
      <span>
        <span>1</span>
      </span>
      <span>
        <span>，表示是第一次尝试执行，通过</span>
      </span>
      <span>
        <span>DAGScheduler</span>
      </span>
      <span>
        <span>触发</span>
      </span>
      <span>
        <span>BeginEvent</span>
      </span>
      <span>
        <span>事件。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(</span>
        <span>taskAttempts</span>
        <span>(</span>
        <span>index</span>
        <span>).size==</span>
        <span>1</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>taskStarted(</span>
        <span>task</span>
        <span>,</span>
        <span>info</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>return</strong>
        </span>
        <span>Some(</span>
        <span>
          <strong>new</strong>
        </span>
        <span>TaskDescription(</span>
        <span>taskId</span>
        <span>,execId,</span>
        <span>taskName</span>
        <span>,</span>
        <span>index</span>
        <span>,</span>
        <span>serializedTask</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>case</strong>
        </span>
        <span>_ =&gt;</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>None</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>TaskSetManager.findTask</span>
      </span>
      <span>
        <span>选择</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>的执行节点的流程部分：</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>从不同的</span>
      </span>
      <span>
        <span>locality</span>
      </span>
      <span>
        <span>级别中取出需要执行的</span>
      </span>
      <span>
        <span>task.</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>private</strong>
          </span>
          <span>
            <strong>def</strong>
          </span>
          findTask(execId: String,host: String, locality: TaskLocality.Value)        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>:Option[(Int, TaskLocality.Value)] =</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>此处优先找</span>
      </span>
      <span>
        <span>PROCESS_LOCAL</span>
      </span>
      <span>
        <span>的值，但是我现在还没有搞明白这个</span>
      </span>
      <span>
        <span>pendingTasksForExecutor</span>
      </span>
      <span>
        <span>的值从何来。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>从</span>
      </span>
      <span>
        <span>TaskSetManager</span>
      </span>
      <span>
        <span>生成时可以看出</span>
      </span>
      <span>
        <span>pendingTasksForExecutor</span>
      </span>
      <span>
        <span>的值在实例生成时</span>
      </span>
      <span>
        <span>,</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>从</span>
      </span>
      <span>
        <span>
          TaskSchedulerImpl.          <span>activeExecutorIds</span>
        </span>
      </span>
      <span>
        <span>中检查并生成。但实例生成此，此容器还没有值。这点还没搞明白。</span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>新的批注：</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>当有</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>的依赖关系时，第一个</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>执行完成后，</span>
      </span>
      <span>
        <span>
          <span>activeExecutorIds</span>
        </span>
      </span>
      <span>
        <span>的容器会有执行过的</span>
      </span>
      <span>
        <span>executor</span>
      </span>
      <span>
        <span>列表。</span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>对上一个</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>执行完成后，新的一个</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>开始执行，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>生成的</span>
      </span>
      <span>
        <span>TaskSetManager</span>
      </span>
      <span>
        <span>中</span>
      </span>
      <span>
        <span>pendingTasksForExecutor</span>
      </span>
      <span>
        <span>中包含可以直接使用上一个</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>中部分</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>执行的</span>
      </span>
      <span>
        <span>executor</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>task.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>因此，如果有</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>的依赖关系时，下一个</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>中的</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>在此时如果</span>
      </span>
      <span>
        <span>executorid</span>
      </span>
      <span>
        <span>相同，直接使用</span>
      </span>
      <span>
        <span>PROCESS_LOCAL</span>
      </span>
      <span>
        <span>来执行。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>第一个</span>
      </span>
      <span>
        <span>stage</span>
      </span>
      <span>
        <span>执行时，</span>
      </span>
      <span>
        <span>PROCESS_LOCAL</span>
      </span>
      <span>
        <span>不会被选择，正常情况</span>
      </span>
      <span>
        <span>locality</span>
      </span>
      <span>
        <span>的选择会放大的</span>
      </span>
      <span>
        <span>NODE_LOCAL</span>
      </span>
      <span>
        <span>开始。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>for</strong>
        </span>
        <span>(</span>
        <span>index</span>
        <span>&lt;-findTaskFromList(getPendingTasksForExecutor(execId))) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>return</strong>
        </span>
        <span>Some((</span>
        <span>index</span>
        <span>,TaskLocality.</span>
        <span>PROCESS_LOCAL</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(TaskLocality.isAllowed(locality, TaskLocality.</span>
        <span>NODE_LOCAL</span>
        <span>)){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>for</strong>
        </span>
        <span>(</span>
        <span>index</span>
        <span>&lt;-findTaskFromList(getPendingTasksForHost(host))) {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>return</strong>
        </span>
        <span>Some((</span>
        <span>index</span>
        <span>,TaskLocality.</span>
        <span>NODE_LOCAL</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(TaskLocality.isAllowed(locality, TaskLocality.</span>
        <span>RACK_LOCAL</span>
        <span>)){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>for</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>rack</span>
        <span>&lt;- sched.getRackForHost(host)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>index</span>
        <span>&lt;- findTaskFromList(getPendingTasksForRack(</span>
        <span>rack</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>} {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>return</strong>
        </span>
        <span>Some((</span>
        <span>index</span>
        <span>,TaskLocality.</span>
        <span>RACK_LOCAL</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//Look for no-</span>
        <span>
          <u>pref</u>
        </span>
        <span>tasks after rack-local tasks since they can run anywhere.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>for</strong>
        </span>
        <span>(</span>
        <span>index</span>
        <span>&lt;-findTaskFromList(</span>
        <span>pendingTasksWithNoPrefs</span>
        <span>)){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>return</strong>
        </span>
        <span>Some((</span>
        <span>index</span>
        <span>,TaskLocality.</span>
        <span>PROCESS_LOCAL</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(TaskLocality.isAllowed(locality, TaskLocality.</span>
        <span>ANY</span>
        <span>)){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>for</strong>
        </span>
        <span>(</span>
        <span>index</span>
        <span>&lt;-findTaskFromList(</span>
        <span>allPendingTasks</span>
        <span>)){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>return</strong>
        </span>
        <span>Some((</span>
        <span>index</span>
        <span>,TaskLocality.</span>
        <span>ANY</span>
        <span>))</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//Finally, if all else has failed, find a speculative task</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>findSpeculativeTask(execId, host,locality)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    appmaster    <span>启动时的补充</span>
  </p>
  <p>
    <span>
      <span>
        <span>一些需要的说明：在</span>
      </span>
      <span>
        <span>makeOffers</span>
      </span>
      <span>
        <span>中调用了</span>
      </span>
      <span>
        <span>TaskScheduler.resourceOffers</span>
      </span>
      <span>
        <span>函数，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>此函数中传入的</span>
      </span>
      <span>
        <span>executorHost,freeCores</span>
      </span>
      <span>
        <span>的值什么时候得到呢：</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>我们知道在</span>
      </span>
      <span>
        <span>appmaster</span>
      </span>
      <span>
        <span>启动的时候。会根据设置的</span>
      </span>
      <span>
        <span>num-worker</span>
      </span>
      <span>
        <span>个数，向</span>
      </span>
      <span>
        <span>rm</span>
      </span>
      <span>
        <span>申请</span>
      </span>
      <span>
        <span>worker</span>
      </span>
      <span>
        <span>运行的资源，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>并通过</span>
      </span>
      <span>
        <span>WorkerRunnable</span>
      </span>
      <span>
        <span>启动</span>
      </span>
      <span>
        <span>worker</span>
      </span>
      <span>
        <span>对应的</span>
      </span>
      <span>
        <span>container</span>
      </span>
      <span>
        <span>。启动</span>
      </span>
      <span>
        <span>CoarseGrainedExecutorBackend</span>
      </span>
      <span>
        <span>实例在</span>
      </span>
      <span>
        <span>container</span>
      </span>
      <span>
        <span>中</span>
      </span>
      <span>
        <span>.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>在实例中连接</span>
      </span>
      <span>
        <span>appmaster</span>
      </span>
      <span>
        <span>对应的</span>
      </span>
      <span>
        <span>sparkContext</span>
      </span>
      <span>
        <span>中的</span>
      </span>
      <span>
        <span>scheduler</span>
      </span>
      <span>
        <span>中的</span>
      </span>
      <span>
        <span>CoarseGrainedSchedulerBackend.DriverActor</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>此</span>
      </span>
    </span>
    <span>
      <span>
        <span>DriverActor</span>
      </span>
    </span>
    <span>
      <span>
        <span>的</span>
      </span>
    </span>
    <span>
      <span>
        <span>name</span>
      </span>
    </span>
    <span>
      <span>
        <span>为</span>
      </span>
    </span>
    <span>
      <span>
        <span>CoarseGrainedSchedulerBackend.</span>
        <span>ACTOR_NAME</span>
        <span>.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>如下是</span>
      </span>
      <span>
        <span>CoarseGrainedExecutorBackend</span>
      </span>
      <span>
        <span>生成的一些代码片段：</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>YarnAllocationHandler.allocateResources</span>
      </span>
      <span>
        <span>中得到</span>
      </span>
      <span>
        <span>actor</span>
      </span>
      <span>
        <span>的名称。</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>val</strong>
          </span>
          <span>workerId</span>
          =          <span>workerIdCounter</span>
          .incrementAndGet().toString        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>driverUrl</span>
        <span>=</span>
        <span>
          <u>"akka.tcp://spark@%s:%s/user/%s"</u>
        </span>
        <span>.format(</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>sparkConf</span>
        <span>.get(</span>
        <span>"spark.driver.host"</span>
        <span>),</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>sparkConf</span>
        <span>.get(</span>
        <span>"spark.driver.port"</span>
        <span>),</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>CoarseGrainedSchedulerBackend.</span>
        <span>ACTOR_NAME</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>YarnAllocationHandler.allocateResources</span>
      </span>
      <span>
        <span>通过</span>
      </span>
      <span>
        <span>WorkerRunnable</span>
      </span>
      <span>
        <span>的线程启动</span>
      </span>
      <span>
        <span>worker</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>container</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>val</strong>
        </span>
        <span>workerRunnable</span>
        <span>=</span>
        <span>
          <strong>new</strong>
        </span>
        <span>WorkerRunnable(</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>container</span>
        <span>,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>conf</span>
        <span>,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>sparkConf</span>
        <span>,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>driverUrl</span>
        <span>,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>workerId</span>
        <span>,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>workerHostname</span>
        <span>,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>workerMemory</span>
        <span>,</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>workerCores</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>new</strong>
        </span>
        <span>Thread(</span>
        <span>workerRunnable</span>
        <span>).start()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>在</span>
      </span>
      <span>
        <span>CoarseGrainedExecutorBackend</span>
      </span>
      <span>
        <span>实例启动时，向</span>
      </span>
      <span>
        <span>actor</span>
      </span>
      <span>
        <span>注册。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>override</strong>
        </span>
        <span>
          <strong>def</strong>
        </span>
        <span>preStart() {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>"Connectingto driver: "</span>
        <span>+ driverUrl)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>driver</span>
        <span>=</span>
        <span>context</span>
        <span>.actorSelection(driverUrl)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>发起</span>
      </span>
      <span>
        <span>worker</span>
      </span>
      <span>
        <span>启动时注册</span>
      </span>
      <span>
        <span>Executor</span>
      </span>
      <span>
        <span>的消息。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <u>driver</u>
        </span>
        <span>!</span>
        <span>
          <u>RegisterExecutor</u>
        </span>
        <span>(executorId,hostPort, cores)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>context</span>
        <span>.system.eventStream.subscribe(</span>
        <span>self</span>
        <span>,classOf[RemotingLifecycleEvent])</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>CoarseGrainedSchedulerBackend</span>
      </span>
      <span>
        <span>中发起</span>
      </span>
      <span>
        <span>RegisterExecutor</span>
      </span>
      <span>
        <span>的事件处理。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>def</strong>
        </span>
        <span>receive = {</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>case</strong>
        </span>
        <span>RegisterExecutor(</span>
        <span>executorId</span>
        <span>,</span>
        <span>hostPort</span>
        <span>,</span>
        <span>cores</span>
        <span>) =&gt;</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>Utils.checkHostPort(</span>
        <span>hostPort</span>
        <span>,</span>
        <span>"Host port expected "</span>
        <span>+</span>
        <span>hostPort</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>如果此</span>
      </span>
      <span>
        <span>executorActor</span>
      </span>
      <span>
        <span>中已经包含有发送此消息过来的</span>
      </span>
      <span>
        <span>actor,</span>
      </span>
      <span>
        <span>表示此</span>
      </span>
      <span>
        <span>worker</span>
      </span>
      <span>
        <span>已经注册，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>通过发送消息过来的</span>
      </span>
      <span>
        <span>actor(sender</span>
      </span>
      <span>
        <span>表示发送此消息的</span>
      </span>
      <span>
        <span>actor)</span>
      </span>
      <span>
        <span>发送一个</span>
      </span>
      <span>
        <span>RegisterExecutorFailed</span>
      </span>
      <span>
        <span>事件。</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>if</strong>
        </span>
        <span>(</span>
        <span>executorActor</span>
        <span>.contains(</span>
        <span>executorId</span>
        <span>)){</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <u>sender</u>
        </span>
        <span>! RegisterExecutorFailed(</span>
        <span>"Duplicateexecutor ID: "</span>
        <span>+</span>
        <span>executorId</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
        <span>
          <strong>else</strong>
        </span>
        <span>{</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>否则表示</span>
      </span>
      <span>
        <span>actor(worker)</span>
      </span>
      <span>
        <span>还没有被注册，把</span>
      </span>
      <span>
        <span>actor</span>
      </span>
      <span>
        <span>添加到</span>
      </span>
      <span>
        <span>executorActor</span>
      </span>
      <span>
        <span>中，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>同时向发送消息过来的</span>
      </span>
      <span>
        <span>actor(sender</span>
      </span>
      <span>
        <span>表示发送此消息的</span>
      </span>
      <span>
        <span>actor)</span>
      </span>
      <span>
        <span>发送一个</span>
      </span>
      <span>
        <span>RegisteredExecutor</span>
      </span>
      <span>
        <span>消息</span>
      </span>
      <span>
        <span>.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>"Registeredexecutor: "</span>
        <span>+ sender +</span>
        <span>"with ID "</span>
        <span>+</span>
        <span>executorId</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <u>sender</u>
          !RegisteredExecutor(sparkProperties)        </span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>executorActor</span>
        <span>(</span>
        <span>executorId</span>
        <span>)= sender</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>添加在</span>
      </span>
      <span>
        <span>TaskScheduler</span>
      </span>
      <span>
        <span>中提交</span>
      </span>
      <span>
        <span>task</span>
      </span>
      <span>
        <span>时使用的</span>
      </span>
      <span>
        <span>executorHost,</span>
      </span>
      <span>
        <span>与</span>
      </span>
      <span>
        <span>freeCores</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>executorHost</span>
        <span>(</span>
        <span>executorId</span>
        <span>)= Utils.parseHostPort(</span>
        <span>hostPort</span>
        <span>).</span>
        <span>_1</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>freeCores</span>
        <span>(</span>
        <span>executorId</span>
        <span>)=</span>
        <span>cores</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>executorAddress</span>
        <span>(</span>
        <span>executorId</span>
        <span>)= sender.path.address</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>addressToExecutorId</span>
        <span>(sender.path.address)=</span>
        <span>executorId</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>totalCoreCount</span>
        <span>.addAndGet(</span>
        <span>cores</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>把现在注册的所有的节点添加到</span>
      </span>
    </span>
    <span>
      <span>
        <span>TaskScheduler.</span>
        <span>executorsByHost</span>
      </span>
    </span>
    <span>
      <span>
        <span>中。在生成</span>
      </span>
    </span>
    <span>
      <span>
        <span>TaskSetManager</span>
      </span>
    </span>
    <span>
      <span>
        <span>是会使用</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>makeOffers()</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>}</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>CoarseGrainedExecutorBackend</span>
      </span>
      <span>
        <span>中接收</span>
      </span>
      <span>
        <span>appmaster</span>
      </span>
      <span>
        <span>中</span>
      </span>
      <span>
        <span>scheduler</span>
      </span>
      <span>
        <span>的</span>
      </span>
      <span>
        <span>receive.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>针对</span>
      </span>
      <span>
        <span>RegisteredExecutor</span>
      </span>
      <span>
        <span>与</span>
      </span>
      <span>
        <span>RegisterExecutorFailed</span>
      </span>
      <span>
        <span>的处理流程：</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>receive</span>
      </span>
      <span>
        <span>函数中处理</span>
      </span>
      <span>
        <span>RegisterExecutorFailed:</span>
      </span>
      <span>
        <span>如果已经存在，直接</span>
      </span>
      <span>
        <span>exit</span>
      </span>
      <span>
        <span>掉此</span>
      </span>
      <span>
        <span>jvm.</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>
          <strong>case</strong>
        </span>
        <span>RegisterExecutorFailed(</span>
        <span>message</span>
        <span>)=&gt;</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>logError(</span>
        <span>"Slaveregistration failed: "</span>
        <span>+</span>
        <span>message</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>System.exit(</span>
        <span>1</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>receive</span>
      </span>
      <span>
        <span>函数中处理</span>
      </span>
      <span>
        <span>RegisteredExecutor:</span>
      </span>
      <span>
        <span>如果不存在，生成</span>
      </span>
      <span>
        <span>Executor</span>
      </span>
      <span>
        <span>实例。此时</span>
      </span>
      <span>
        <span>worker</span>
      </span>
      <span>
        <span>启动完成，</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>并向</span>
      </span>
      <span>
        <span>master</span>
      </span>
      <span>
        <span>注册成功。</span>
      </span>
    </span>
  </p>
  <p>
    <font>
      <span>
        <span>
          <span>
            <strong>case</strong>
          </span>
          RegisteredExecutor(          <span>sparkProperties</span>
          ) =&gt;        </span>
      </span>
    </font>
  </p>
  <p>
    <span>
      <span>
        <span>logInfo(</span>
        <span>"Successfullyregistered with driver"</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>//Make this host instead of hostPort ?</span>
      </span>
    </span>
  </p>
  <p>
    <span>
      <span>
        <span>executor</span>
        <span>=</span>
        <span>
          <strong>new</strong>
        </span>
        <span>Executor(executorId, Utils.parseHostPort(hostPort).</span>
        <span>_1</span>
        <span>,</span>
        <span>sparkProperties</span>
        <span>)</span>
      </span>
    </span>
  </p>
  <h2>
    RDD    <span>的依赖关系</span>
  </h2>
  <p>
    <span>..........</span>
  </p>
  <h2>
    Spark    <span>中的</span>
    Scheduler  </h2>
  <p>
    <span>........</span>
  </p>
  <p>
    <span>Task</span>
    <span>
      <span>的执行过程</span>
    </span>
  </p>
</div>

        </div>
        <div class="article_social">
         <div class="article_like">
    <div class="circle circle-like" id="my_zan" data_id="JBjQRr">
    </div>
</div>
        <div id="share_weixin_image">
            <img width="100px" height="100px" src="./spark 启动job的流程分析 - 推酷_files/qrcode.php">
        </div>
<div class="article_share_fav">
    <div class="share" id="ckepop">
        <span>分享</span>
        <button class="share_weibo" id="share_weibo_id" title="分享到新浪微博"></button>
        <button class="share_qq" id="share_qq_id" title="分享到QQ空间"></button>
        <button class="share_weixin" id="share_weixin_id"></button>
    </div>
    <div class="fav_correct">
        <button id="my_fav" data_id="JBjQRr">
            <i class="icon icon-star-empty"></i> <span id="fav_tip">收藏</span>
        </button>
        <button id="article-correct" data_id="JBjQRr">
            <i class="icon icon-warning-sign"></i>
            <span>纠错</span>
        </button>
    </div>
</div>
<script type="text/javascript">
$("#share_weibo_id").click( function() {
   window.open("http://share.baidu.com/s?type=text&searchPic=0&sign=on&to=tsina&url=http://www.tuicool.com/articles/JBjQRr&title=spark+%E5%90%AF%E5%8A%A8job%E7%9A%84%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90++%28%E5%88%86%E4%BA%AB%E8%87%AA+%40%E6%8E%A8%E9%85%B7%E7%BD%91%29&key=3113829255");
});
$("#share_qq_id").click( function() {
   window.open("http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.tuicool.com/articles/JBjQRr&title=spark+%E5%90%AF%E5%8A%A8job%E7%9A%84%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90&desc=&summary=&site=");
});
$("#share_weixin_id").click( function() {
  $("#share_weixin_image").toggle();
});
</script>


            <div class="bottom_ad huodong-detail-ad-banner clearfix">
            <script type="text/javascript">
    var cpro_id = "u1665123";
</script>
<script src="./spark 启动job的流程分析 - 推酷_files/c.js" type="text/javascript"></script><div id="BAIDU_EXP_UNION__wrapper_u1665123_0"><iframe id="iframeu1665123_0" src="./spark 启动job的流程分析 - 推酷_files/acom.html" width="580" height="90" align="center,center" vspace="0" hspace="0" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" style="border:0; vertical-align:bottom;margin:0;" allowtransparency="true"></iframe></div>

            </div>
        </div>
        <div id="site_articles" style="clear:both;">
              <div class="article-part-title">
                <span>推荐文章</span>
              </div>
          <ul class="side_article_list">
                <li class="side_article_list_item">
                    1.<a href="http://www.tuicool.com/articles/63YnQzz" target="_blank" title="大数据系列之(一) Streaming模式基础知识">
                    大数据系列之(一) Streaming模式基础知识
                    </a>
                </li>
                <li class="side_article_list_item">
                    2.<a href="http://www.tuicool.com/articles/j6jMv2a" target="_blank" title="使用Docker在本地搭建hadoop，spark集群">
                    使用Docker在本地搭建hadoop，spark集群
                    </a>
                </li>
                <li class="side_article_list_item">
                    3.<a href="http://www.tuicool.com/articles/ziYbY3n" target="_blank" title="Docker结合OpenStack在思源的经验分享">
                    Docker结合OpenStack在思源的经验分享
                    </a>
                </li>
                <li class="side_article_list_item">
                    4.<a href="http://www.tuicool.com/articles/aAjqMna" target="_blank" title="Apache Eagle：eBay开源分布式实时Hadoop数据安全引擎">
                    Apache Eagle：eBay开源分布式实时Hadoop数据安全引擎
                    </a>
                </li>
                <li class="side_article_list_item">
                    5.<a href="http://www.tuicool.com/articles/BFnY7vv" target="_blank" title="Apache Kylin在百度地图的实践">
                    Apache Kylin在百度地图的实践
                    </a>
                </li>
                <li class="side_article_list_item">
                    6.<a href="http://www.tuicool.com/articles/ii2MveB" target="_blank" title="Spark Standalone模式">
                    Spark Standalone模式
                    </a>
                </li>
          </ul>
        </div>
        <div id="kan_articles"> <div class="article-part-title"> <span>相关推刊</span></div><ul class="kan-list">          <li class="kan-item">            <a href="http://www.tuicool.com/kans/2832655025" target="_blank" class="kan-item-head">              <small>刊主：iwang10</small>              <img class="kan-cover" src="./spark 启动job的流程分析 - 推酷_files/default_kan_cover.png">            </a>            <span class="kan-detail">              <a href="http://www.tuicool.com/kans/2832655025" target="_blank">《默认推刊》</a>              <i class="kan-num">6</i>            </span>          </li>        </ul><i class="clearfix"></i></div>
        <div id="article_weibo" style="display:none;">
            <div class="article-part-title">
                <span>相关微博</span>
                <sub>
                    <a href="http://www.tuicool.com/articles/weibo_list/JBjQRr" target="_blank">(<i id="weibo_num"></i>)</a> 
               </sub>
            </div>
            <div class="related-weibo-list"></div>
        </div>
        <div class="comments">
    <div class="comments-area">
    <div class="comments-header">
        <h5>我来评几句</h5>
        <div class="alert comment-alert alert-error" style="display:none;">
            错误
        </div>
            <textarea cols="60" rows="5" id="comment-body" placeholder="请输入评论内容..." style="resize: none;"></textarea>
            <span class="btn btn-medium btn-submit" id="comment-submit">登录后评论</span>
        <p style="margin-top: 5px;margin-left:10px;">
            已发表评论数(<span class="comment_cnt">0</span>)
        </p>
    </div>
    <div class="comments-list">
        <div class="empty-cmts alert alert-success" style="display:none;">
            没有更多评论了^^
        </div>
    </div>
    <div class="more-comments" style="display:none;">
        <a href="">更多评论</a>
    </div>
    <div class="load-fail" style="display:none;">
        评论加载失败，<a href="javascript:reload_comments('JBjQRr',1,0,-1);">重新加载</a>
    </div>
    </div>
</div>

    </div>
        <div class="span4 article_right_side">
            <div class="right_top">
    <div class="article_related_site article_detail_bg">
    <h4 class="article-part-title">相关站点</h4>
    <div class="article_related_site_body clearfix">
        <div class="logo">
            <img src="./spark 启动job的流程分析 - 推酷_files/vQZRB3.png">
        </div>
        <div class="name">
            <div>
                <a href="http://www.tuicool.com/sites/vQZRB3" target="_blank"> CSDN博客</a>
            </div>
            <div>
                    <input type="button" class="btn btn-success right_site_follow" value="+ 订阅" id="my_follow" data_id="vQZRB3">
            </div>
        </div>
    </div>
</div>

<div class="right-ad">
      <a href="https://www.teambition.com/?utm_source=tuicool&utm_medium=banner01" target="_blank"><img src="./spark 启动job的流程分析 - 推酷_files/teambition300.jpg"></a>

</div>
<div class="right-ad" style="margin-top: 8px">
      <a href="http://click.aliyun.com/m/3403/" target="_blank"><img src="./spark 启动job的流程分析 - 推酷_files/aliyun300.jpg"></a>

</div>
<div class="right-ad" style="margin-top: 8px">
      <a href="http://home.leangoo.com/?f=tc" target="_blank"><img src="./spark 启动job的流程分析 - 推酷_files/leangoo300.jpg"></a>

</div>
<div class="right-ad" style="margin-top: 8px">
      <a href="http://yacebao.com/?utm_source=web&utm_medium=banner&utm_campaign=tuicool" target="_blank"><img src="./spark 启动job的流程分析 - 推酷_files/yunzhihui300.jpg"></a>

</div>
<div id="right_site_articles" class="article_detail_bg">
    <div class="article-part-title">
        <span>热门文章</span>
    </div>
    <ul class="side_article_list">
        <li class="side_article_list_item">
            1.<a href="http://www.tuicool.com/articles/63YnQzz" target="_blank" title="大数据系列之(一) Streaming模式基础知识"> 大数据系列之(一) Streaming模式基础知识 </a>
        </li>
        <li class="side_article_list_item">
            2.<a href="http://www.tuicool.com/articles/j6jMv2a" target="_blank" title="使用Docker在本地搭建hadoop，spark集群"> 使用Docker在本地搭建hadoop，spark集群 </a>
        </li>
        <li class="side_article_list_item">
            3.<a href="http://www.tuicool.com/articles/ziYbY3n" target="_blank" title="Docker结合OpenStack在思源的经验分享"> Docker结合OpenStack在思源的经验分享 </a>
        </li>
        <li class="side_article_list_item">
            4.<a href="http://www.tuicool.com/articles/aAjqMna" target="_blank" title="Apache Eagle：eBay开源分布式实时Hadoop数据安全引擎"> Apache Eagle：eBay开源分布式实时Hadoop数据安全引擎 </a>
        </li>
        <li class="side_article_list_item">
            5.<a href="http://www.tuicool.com/articles/BFnY7vv" target="_blank" title="Apache Kylin在百度地图的实践"> Apache Kylin在百度地图的实践 </a>
        </li>
        <li class="side_article_list_item">
            6.<a href="http://www.tuicool.com/articles/ii2MveB" target="_blank" title="Spark Standalone模式"> Spark Standalone模式 </a>
        </li>
    </ul>
</div>
</div>

<div class="operate_zone" style="position: fixed; top: 50px;">
    <div class="container-body share-body">
        <div class="article-part-title">
            <span>分享本文</span>
        </div>
        <div class="share_zone">
    <div class="bdsharebuttonbox bdshare-button-style1-24" data-bd-bind="1452138661694"> 
         <a href="http://www.tuicool.com/articles/JBjQRr#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
        <a href="http://www.tuicool.com/articles/JBjQRr#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
        <a href="http://www.tuicool.com/articles/JBjQRr#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a>
        <a href="http://www.tuicool.com/articles/JBjQRr#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a>
        <a href="http://www.tuicool.com/articles/JBjQRr#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
        <a href="http://www.tuicool.com/articles/JBjQRr#" class="bds_more" data-cmd="more"></a>
     </div>
    <script>
        window._bd_share_config = {
            "common" : {
                "bdSnsKey" : {
                    "tsina" : "3113829255",
                    "tqq" : "801536792"
                },
                "bdText" : "spark 启动job的流程分析 (分享自 @推酷网)",
                "bdMini" : "2",
                "bdMiniList" : false,
                "bdPic" : "",
                "bdStyle" : "1",
                "bdSize" : "24"
            },
            "share" : {}
        };
        with (document)
        0[(getElementsByTagName('head')[0] || body).appendChild(createElement('script')).src = 'http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=' + ~(-new Date() / 36e5)];
    </script>
</div>
    </div>
        <div class="frd_pos">
        <script async="" src="./spark 启动job的流程分析 - 推酷_files/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display: inline-block; width: 300px; height: 250px;" data-ad-client="ca-pub-7054762349007490" data-ad-slot="5705695566" data-adsbygoogle-status="done"><ins id="aswift_0_expand" style="display:inline-table;border:none;height:250px;margin:0;padding:0;position:relative;visibility:visible;width:300px;background-color:transparent"><ins id="aswift_0_anchor" style="display:block;border:none;height:250px;margin:0;padding:0;position:relative;visibility:visible;width:300px;background-color:transparent"><iframe width="300" height="250" frameborder="0" marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" allowfullscreen="true" onload="var i=this.id,s=window.google_iframe_oncopy,H=s&amp;&amp;s.handlers,h=H&amp;&amp;H[i],w=this.contentWindow,d;try{d=w.document}catch(e){}if(h&amp;&amp;d&amp;&amp;(!d.body||!d.body.firstChild)){if(h.call){setTimeout(h,0)}else if(h.match){try{h=s.upd(h,i)}catch(e){}w.location.replace(h)}}" id="aswift_0" name="aswift_0" style="left:0;position:absolute;top:0;"></iframe></ins></ins></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

        </div>
</div>
         </div>
</div>

<div class="read-later-alert">
</div>
<div>
   <a href="http://www.tuicool.com/articles/JBjQRr#add-article-to-kan" id="add-article-to-kan-btn" class="btn" data-toggle="modal" style="display:none;">添加到推刊</a>
   <!-- add_article to kan -->
<div id="add-article-to-kan" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <span class="add-title">收藏到推刊</span>
    <a href="http://www.tuicool.com/articles/JBjQRr#new-kan" class="btn pull-right" data-toggle="modal">创建推刊</a>
    <i class="clearfix"></i>
  </div>
  <div class="modal-body">
    <ul id="add-kan-list">
    </ul>
  </div>
  <div class="modal-footer">
    <input type="hidden" value="JBjQRr" class="article-id"> 
    <button class="btn btn-primary pull-left add-to-btn">  收 藏  </button>
    <button class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
  </div>
</div>
<div class="add-article-to-kan-alert">
  已收藏到推刊！
</div>

   <div id="new-kan" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-body">
    <input type="text" name="name" id="new-kan-name" placeholder="推刊名(必填)" required="" data-validation-required-message="请填写推刊名">
    <span class="new-ness-name">请填写推刊名</span>
    <br>
    <textarea name="desc" id="desc" rows="6" placeholder="推刊描述"></textarea>
    <span class="new-ness-desc">描述不能大于100个字符!</span>
    <br>
    权限设置：<input type="radio" name="type" value="1" checked="checked"> 公开
    <input type="radio" name="type" value="0"> 仅自己可见
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary pull-left create-kan-btn" disabled="">创建</button>
    <button class="btn dismiss-new-kan" data-dismiss="modal" aria-hidden="true">取消</button>
  </div>
</div>


</div>
<div id="article-correct-modal" class="modal hide fade in" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="false">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
            ×
        </button>
        <h3>文章纠错</h3>
    </div>
    <div class="modal-body">
        <input type="hidden" value="JBjQRr" id="article-correct-source">
        <div>
            <label for="article-correct-email">
                邮箱地址
            </label>
            <input type="email" id="article-correct-email" class="input-large">
        </div>
        <div>
            <label for="article-correct-select">
                错误类型
            </label>
            <select id="article-correct-select">
                <option value="正文不准确">正文不准确</option>
                <option value="排版有问题">排版有问题</option>
                <option value="没有分页内容">没有分页内容</option>
                <option value="视频无法显示">视频无法显示</option>
                <option value="图片无法显示">图片无法显示</option>
            </select>
        </div>
        <div>
            <label for="article-correct-other">
                补充信息
            </label>
            <textarea id="article-correct-other" class="span6"></textarea>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-primary pull-right huodong_correct_submit" id="article-correct-submit">
            &nbsp;&nbsp;提交&nbsp;&nbsp;
        </button>
    </div>
</div>

<style type="text/css">
    .btn-large {
        padding: 0;
    }
    .load-fail {
        display: none;
    }
</style>
<script src="./spark 启动job的流程分析 - 推酷_files/highlight.pack.js"></script>
<script type="text/javascript">
    $('table').each(function(i) {
        var size = $(this).children().size();
        if (size > 1) {
            $(this).attr('class',"table table-bordered");
        } else if (size == 1) {
            var e11 = $(this).children(":first");
            var e1 = e11[0];
            var name = e1.nodeName.toLowerCase();
            if ("tbody" == name) {
                if (e11.children().size() > 1) {
                     $(this).attr('class',"table table-bordered");
                }
            }
        }
    });
            related_kan("JBjQRr");
        window.page = 0;
        window.last = 0;    
        window.first = true;
        resize_article_image('#nei', 550);
                load_comments("JBjQRr",1,0,-1);
                window.uid = -1;
        open_add_article_to_kan("false");
        async_do_zan_article(); 
        $('pre').each(function(i, e) {
            hljs.highlightBlock(e, "<span class='indent'>  </span>", false)
        });
       
          
       handle_follow_site("#my_follow","已订阅","+ 订阅");
</script>


  </div>

    <div class="footer">
    <div class="footer-inner">
    <dl class="about-link site-link">
        <dt>
            网站相关
        </dt>
        <dd>
            <a target="_blank" href="http://www.tuicool.com/about">关于我们</a>
        </dd>
        <dd>
            <a target="_blank" href="http://www.tuicool.com/mobile">移动应用</a>
        </dd>
        <dd>
            <a target="_blank" href="http://www.tuicool.com/bbs/go/issues">建议反馈</a>
        </dd>
    </dl>
    <dl class="site-link follow-link">
        <dt>
            关注我们
        </dt>
        <dd>
            <a target="_blank" href="http://e.weibo.com/tuicool2012"><img src="./spark 启动job的流程分析 - 推酷_files/weibo-32.png">推酷网</a>
        </dd>
        <dd><img src="./spark 启动job的流程分析 - 推酷_files/weixin-32.png">tuicool2012
        </dd>
    </dl>
    <dl class="site-link links">
        <dt>
            友情链接
        </dt>
        <dd>
                <a href="http://www.woshipm.com/" title="人人都是产品经理" target="_blank">人人都是产品经理</a>
                <a href="http://www.moobuu.com/" title="魔部网" target="_blank">魔部网</a>
                <a href="http://www.pm265.com/" title="PM256" target="_blank">PM256</a>
                <a href="http://www.pintu360.com/" title="品途网" target="_blank">品途网</a>
                <a href="http://www.yidonghua.com/" title="移动信息化" target="_blank">移动信息化</a>
                <a href="http://www.snsiu.com/" title="行晓网" target="_blank">行晓网</a>
                <a href="http://code4app.com/" title="Code4App" target="_blank">Code4App</a>
                <a href="http://www.taskcity.com/" title="智城外包网" target="_blank">智城外包网</a>
                <a href="http://blog.lamper.cn/" title="LAMP人" target="_blank">LAMP人</a>
                <a href="http://www.apkway.com/forum.php" title="安卓航班网" target="_blank">安卓航班网</a>
                <a href="http://www.huxiu.com/" title="虎嗅" target="_blank">虎嗅</a>
                <a href="http://www.ycpai.com/" title="缘创派" target="_blank">缘创派</a>
                <a href="http://www.iterduo.com/" title="IT耳朵" target="_blank">IT耳朵</a>
                <a href="http://www.iresearch.cn/" title="艾瑞网" target="_blank">艾瑞网</a>
                <a href="http://mediaworks.caixin.com/" title="创媒工场" target="_blank">创媒工场</a>
                <a href="http://www.leiphone.com/" title="雷锋网" target="_blank">雷锋网</a>
                <a href="http://www.managershare.com/" title="经理人分享" target="_blank">经理人分享</a>
                <a href="http://www.shichangbu.com/" title="市场部网" target="_blank">市场部网</a>
                <a href="http://www.ikanchai.com/" title="砍柴网" target="_blank">砍柴网</a>
                <a href="http://www.cocoachina.com/" title="CocoaChina" target="_blank">CocoaChina</a>
                <a href="http://www.ibeifeng.com/" title="北风网" target="_blank">北风网</a>
                <a href="http://www.jiankongbao.com/" title="云智慧" target="_blank">云智慧</a>
                <a href="http://www.wyzc.com/" title="我赢职场" target="_blank">我赢职场</a>
                <a href="http://www.thebigdata.cn/" title="大数据时代" target="_blank">大数据时代</a>
                <a href="http://www.qidic.com/" title="奇笛网" target="_blank">奇笛网</a>
                <a href="http://www.cngulu.com/" title="咕噜网" target="_blank">咕噜网</a>
                <a href="http://www.linuxdiyf.com/" title="红联linux" target="_blank">红联linux</a>
                <a href="http://win10.ithome.com/" title="Win10之家" target="_blank">Win10之家</a>
                <a href="http://www.niaogebiji.com/" title="鸟哥笔记" target="_blank">鸟哥笔记</a>
                <a href="http://www.play.cn/" title="爱游戏" target="_blank">爱游戏</a>
                <a href="http://www.investide.cn/" title="投资潮" target="_blank">投资潮</a>
                <a href="http://www.31huiyi.com/" title="31会议网" target="_blank">31会议网</a>
                <a href="https://www.jpush.cn/" title="极光推送" target="_blank">极光推送</a>
                <a href="https://www.teambition.com/" title="Teambition" target="_blank">Teambition</a>
                <a href="http://cn.cocos2d-x.org/" title="Cocos引擎中文官网" target="_blank">Cocos引擎中文官网</a>
                <a href="http://www.guigu.org/" title="硅谷网" target="_blank">硅谷网</a>
                <a href="https://home.leangoo.com/" title="leangoo" target="_blank">leangoo</a>
            <a href="http://www.tuicool.com/links">更多链接&gt;&gt;</a>&nbsp;&nbsp;
        </dd>
    </dl>
    <div class="clear"></div>
    </div>
</div>

<div style="display:none;">
   <script src="./spark 启动job的流程分析 - 推酷_files/stat.php" language="JavaScript"></script><script src="./spark 启动job的流程分析 - 推酷_files/core.php" charset="utf-8" type="text/javascript"></script><a href="http://www.cnzz.com/stat/website.php?web_id=5541078" target="_blank" title="站长统计"><img border="0" hspace="0" vspace="0" src="./spark 启动job的流程分析 - 推酷_files/pic.gif"></a>
</div>




<div class="return" title="返回顶部" style="display: block;"></div></body></html>